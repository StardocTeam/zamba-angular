Imports System.IO
Imports Zamba.Filters
Imports Zamba.Servers
Imports System.Data
Imports System.Collections
Imports Zamba.Data
Imports System.Text
Imports System.Collections.Generic
Imports Zamba.Framework.Search.Components
Imports Zamba.Framework.Search.Data
Imports Zamba.Core.DocTypes.DocAsociated
Imports Zamba.Framework

Namespace Search
    ''' -----------------------------------------------------------------------------
    ''' Project	 : Zamba.Business
    ''' Class	 : Core.ModDocuments
    ''' 
    ''' -----------------------------------------------------------------------------
    ''' <summary>
    ''' Clase estatica para realizar busquedas de documentos en Zamba
    ''' </summary>
    ''' <remarks>
    ''' </remarks>
    ''' <history>
    ''' 	[Hernan]	29/05/2006	Created
    ''' </history>
    ''' -----------------------------------------------------------------------------
    Public Class ModDocuments
        'Inherits ZClass

        Dim RB As New Results_Business
        Dim UB As New UserBusiness
        Dim MisTareasSinFiltro As Boolean = False


#Region "IndexSearch"
        Public Overloads Function DoSearchAsocWithWF(ByVal CurrentDocType As DocType, ByVal Indexs As List(Of IIndex), ByVal UserId As Int64, ByVal LastPage As Int64, ByVal PageSize As Int32, ByVal docId As Int64, ByVal currentUserName As String) As DataTable
            Dim dtResults As New DataTable
            Try
                Dim i As Int32
                dtResults.MinimumCapacity = 0

                Dim MD As New ModDocuments
                Dim dt As DataTable = MD.SearchRowsAsocForm(CurrentDocType, Indexs, UserId, LastPage, PageSize, docId, currentUserName)
                MD = Nothing
                If dt IsNot Nothing Then
                    dtResults.MinimumCapacity = dtResults.MinimumCapacity + dt.MinimumCapacity
                    dtResults.Merge(dt)
                End If

                Return dtResults
            Catch ex As Threading.SynchronizationLockException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadAbortException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadInterruptedException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadStateException
                ZClass.raiseerror(ex)
            Catch ex As Exception
                ZClass.raiseerror(ex)
            End Try
            Return New DataTable()
        End Function

        Public Overloads Function DoSearch(ByRef search As Searchs.Search,
                                           ByVal UserId As Int64,
                                           ByVal LastPage As Int64,
                                           ByVal PageSize As Int32,
                                           ByVal isAssociatedSearch As Boolean,
                                           ByVal UseFilters As Boolean,
                                           ByVal DtoOnly As Boolean, ByRef TotalCount As Int64) As DataTable
            Dim dtResults As New DataTable
            Dim SearchName As String = String.Empty

            Dim SearchsEntities As New List(Of Int64)

            For Each DocType As IDocType In search.Doctypes
                SearchsEntities.Add(DocType.ID)
            Next


            If search.View = "MyTasks,MyTeam" Then
                MisTareasSinFiltro = True
            End If

            Try
                If Not String.IsNullOrEmpty(search.Textsearch) Then
                    'SOLO  BUSQUEDA EN TODOS LOS INDICES
                    Dim dsResultsId As DataSet = Nothing
                    Try
                        Dim ST As New SearchToolsData(Server.Con)

                        dsResultsId = ST.SearchInAllIndexs(search)
                        If dsResultsId.Tables.Count <> 0 Then
                            For Each r As DataRow In dsResultsId.Tables(0).Rows
                                Dim drResult As DataRow = RB.GetResultRow(CType(r(0), Int64), CType(r(1), Int64))
                                If Not IsNothing(drResult) Then
                                    dtResults.Merge(drResult.Table)
                                End If
                            Next
                        End If
                    Catch ex As Exception
                        SearchName = Now.ToString
                    Finally
                        If dsResultsId IsNot Nothing Then
                            dsResultsId.Dispose()
                            dsResultsId = Nothing
                        End If
                    End Try

                    If Not isAssociatedSearch Then
                        UB.SaveAction(2, ObjectTypes.Documents, RightsType.Buscar, "Se realizó una búsqueda por la palabra: " & search.Textsearch)
                    End If
                    'ElseIf search.SearchType = SearchTypes.AsignedTasks Then
                    '    dtResults.MinimumCapacity = 0
                    '    Dim dt As DataTable = SearchRows(Nothing, search.Indexs, UserId, LastPage, PageSize, UseFilters, SearchsEntities, DtoOnly, UserId, search.OrderBy, search.Filters, search)
                    '    If Not IsNothing(dt) Then
                    '        dtResults.MinimumCapacity = dtResults.MinimumCapacity + dt.MinimumCapacity
                    '        dtResults.Merge(dt)
                    '    End If
                    '    dt = Nothing
                    '    If Not isAssociatedSearch Then
                    '        Try
                    '            Dim indexsstring As String = String.Empty
                    '            If Not IsNothing(search.Indexs) Then
                    '                For Each ind As IIndex In search.Indexs
                    '                    indexsstring &= ". Se filtro por el índice '" & ind.Name & " (" & ind.ID & ")' con el operador '" & ind.Operator & "' y valor '" & ind.DataTemp & "'"
                    '                Next
                    '            End If
                    '            UB.SaveAction(2, ObjectTypes.Documents, RightsType.Buscar, "Se realizó búsqueda por el entidad: Mis Tareas")
                    '        Catch ex As Exception
                    '            ZClass.raiseerror(ex)
                    '        End Try
                    '    End If
                Else
                    Dim CurrentDocType As DocType
                    Dim i As Int32
                    dtResults.MinimumCapacity = 0
                    For i = 0 To search.Doctypes.Count - 1
                        CurrentDocType = search.Doctypes(i)
                        CurrentDocType.Indexs = ZCore.GetInstance().FilterIndex(CurrentDocType.ID)
                        Dim Count As Int64
                        Dim dt As DataTable = SearchRows(CurrentDocType, search.Indexs, UserId, LastPage, PageSize, UseFilters, SearchsEntities, DtoOnly, UserId, search.OrderBy, search.Filters, search, Count)
                        If Not IsNothing(dt) Then
                            TotalCount = TotalCount + Count
                            dtResults.Merge(dt)
                            If (search.ResultsCount.ContainsKey(CurrentDocType.ID)) Then
                                search.ResultsCount(CurrentDocType.ID) = dt.MinimumCapacity
                            Else
                                search.ResultsCount.Add(CurrentDocType.ID, dt.MinimumCapacity)
                            End If
                        End If
                        dt = Nothing

                        If Not isAssociatedSearch Then
                            Try
                                Dim indexsstring As String = String.Empty
                                If Not IsNothing(search.Indexs) Then
                                    For Each ind As IIndex In search.Indexs
                                        indexsstring &= ". Se filtro por el índice '" & ind.Name & " (" & ind.ID & ")' con el operador '" & ind.Operator & "' y valor '" & ind.DataTemp & "'"
                                    Next
                                End If
                                UB.SaveAction(2, ObjectTypes.Documents, RightsType.Buscar,
                                                                   "Se realizó búsqueda por el entidad: " _
                                                                   & CurrentDocType.Name & " (" & CurrentDocType.ID & ")" & indexsstring)

                            Catch ex As Exception
                                ZClass.raiseerror(ex)
                            End Try
                        End If
                    Next
                End If

                SearchName = Nothing
                Return dtResults
            Catch ex As Threading.SynchronizationLockException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadAbortException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadInterruptedException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadStateException
                ZClass.raiseerror(ex)
            End Try
            Return Nothing
        End Function

        Public Overloads Function DoGlobalSearch(ByVal search As Searchs.Search,
                                                 ByVal UserId As Int64,
                                                 ByVal LastPage As Int64,
                                                 ByVal PageSize As Int32,
                                                 ByVal isAssociatedSearch As Boolean,
                                                 ByVal UseFilters As Boolean,
                                                 ByVal DtoOnly As Boolean) As DataTable
            Dim dtResults As New DataTable
            Dim CurrentDocType As DocType
            Dim SearchName As String = String.Empty

            Dim SearchsEntities As New List(Of Int64)

            For Each DocType As IDocType In search.Doctypes
                SearchsEntities.Add(DocType.ID)
            Next

            Try
                If Not String.IsNullOrEmpty(search.Textsearch) Then
                    'SOLO  BUSQUEDA EN TODOS LOS INDICES
                    Try
                        Dim ST As New SearchToolsData(Server.Con)
                        dtResults = ST.SearchGlobalInAllIndexs(search).Tables(0)
                    Catch ex As Exception
                        SearchName = Now.ToString
                    End Try

                    If Not isAssociatedSearch Then
                        UB.SaveAction(2, ObjectTypes.Documents, RightsType.Buscar, "Se realizó una búsqueda por la palabra: " & search.Textsearch)
                    End If

                Else
                    Dim i As Int32
                    dtResults.MinimumCapacity = 0
                    Dim TotalCount As Int64 = 0
                    For i = 0 To search.Doctypes.Count - 1
                        CurrentDocType = search.Doctypes(i)
                        CurrentDocType.Indexs = ZCore.GetInstance().FilterIndex(CurrentDocType.ID)
                        Dim Count As Int64
                        Dim dt As DataTable = SearchRows(CurrentDocType, search.Indexs, UserId, LastPage, PageSize, UseFilters, SearchsEntities, DtoOnly, UserId, search.OrderBy, search.Filters, search, Count)
                        If Not IsNothing(dt) Then
                            TotalCount = TotalCount + Count
                            dtResults.Merge(dt)
                        End If
                        dt = Nothing

                        If Not isAssociatedSearch Then
                            Try
                                Dim indexsstring As String = String.Empty
                                If Not IsNothing(search.Indexs) Then
                                    For Each ind As IIndex In search.Indexs
                                        indexsstring &= ". Se filtro por el índice '" & ind.Name & " (" & ind.ID & ")' con el operador '" & ind.Operator & "' y valor '" & ind.DataTemp & "'"
                                    Next
                                End If
                                UB.SaveAction(2, ObjectTypes.Documents, RightsType.Buscar,
                                                                   "Se realizó búsqueda por el entidad: " _
                                                                   & CurrentDocType.Name & " (" & CurrentDocType.ID & ")" & indexsstring)

                            Catch ex As Exception
                                ZClass.raiseerror(ex)
                            End Try
                        End If
                    Next
                End If

                SearchName = Nothing
                search = Nothing
                Return dtResults
            Catch ex As Threading.SynchronizationLockException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadAbortException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadInterruptedException
                ZClass.raiseerror(ex)
            Catch ex As Threading.ThreadStateException
                ZClass.raiseerror(ex)
            End Try
            Return Nothing
        End Function

        Const ORACLE_PAGINATE_FORMAT As String = "(rn <= {1} and rn >= {0})"
        Private Function GetTaskTable(ByVal strQuery As StringBuilder, ByVal strPREselect As StringBuilder, ByVal strPOSTselect As StringBuilder, ByVal Orden As String, ByVal PageSize As Int32, ByVal LastPage As Int32, ByVal search As ISearch, ByRef count As Int64) As DataTable

            Dim Desde As Int32
            Dim Hasta As Int32
            Desde = (PageSize * LastPage) + 1
            Hasta = Desde + PageSize - 1

            Dim query As String = strQuery.ToString
            Dim Total As Int64
            Dim ds As DataSet

            If Server.isOracle Then
                query = query.Replace("Exclusive,", "C_Exclusive,")
                query = query.Replace(") as Q", ")")
                query = query.Replace("[", Chr(34))
                query = query.Replace("]", Chr(34))


                'Se genera el query para hacer el count
                Dim strCountQuery As New StringBuilder("select count(1) ")
                strCountQuery.Append(query.Substring(query.IndexOf("FROM")))

                'Se agrega subconsulta para poder hacer paginacion
                strQuery.Insert(0, "select " & strPREselect.ToString() & ",I.* from (")
                strQuery.Append(") I ")
                strQuery.Append(strPOSTselect.ToString())
                strQuery.Append(" where ")

                strQuery.AppendFormat(ORACLE_PAGINATE_FORMAT, Desde, Hasta)

                'En oracle no iria el Order By acá
                If search.SearchType = SearchTypes.AsignedTasks Then
                    strQuery.Append(" order by ")

                    'Ordenamiento extreno
                    If Orden.Contains(Chr(34)) Then
                        Dim ordensincomillas As String = Nothing
                        Dim OrderDocidExt As String = Nothing

                        If Orden.Contains("slst_s") Then
                            Dim OrdenSlst_s As String = Nothing
                            Dim SplitStrSelectExt As String = Nothing
                            Dim SplitSlst_s() As String = Nothing
                            Dim indexAlias As String = Nothing
                            Dim AscORDesc As String = Nothing
                            Dim tmpList As New List(Of String)
                            Dim SplitSlstExt As String = Nothing

                            SplitSlst_s = strPREselect.ToString.Split(",")

                            For Each s As String In SplitSlst_s
                                If s.Contains("slst_s") Then
                                    Dim listslst_s As String = Nothing
                                    listslst_s = s.Split(".")(0).Trim()
                                    tmpList.Add(listslst_s)
                                End If
                            Next

                            SplitSlstExt = Orden.Split(".")(0).Replace(Chr(34), "")

                            If tmpList.Contains(SplitSlstExt) Then
                                SplitStrSelectExt = Orden.Split(".")(0)
                                AscORDesc = Orden.Split(".")(1).Split(" ")(1)
                                OrdenSlst_s = SplitStrSelectExt.Split("s")(3)
                                indexAlias = IndexsBusiness.GetIndexName(OrdenSlst_s).Trim
                                Orden = (Chr(34) + indexAlias + Chr(34)) + " " + AscORDesc
                            Else
                                Orden = "I.doc_id desc"
                            End If

                        ElseIf Orden.Contains("ASSIGNEDTO") OrElse Orden.Contains("STEP") OrElse Orden.Contains("INGRESO") Then
                            ordensincomillas = Orden.Substring(0, Orden.Length).Replace(Chr(34), "")
                            Orden = ordensincomillas
                        ElseIf Orden.Contains("DOC TYPE NAME") Then
                            Dim AscORDesc As String = Nothing
                            AscORDesc = Orden.Split(" ")(3)
                            Orden = "ENTIDAD " + AscORDesc
                        ElseIf Flagdocid = True Then
                            Orden = "I.doc_id desc"
                            Flagdocid = False
                        Else
                            Orden = ("I." + Orden)
                        End If
                    End If
                    strQuery.Append(Orden)
                End If

                ds = Server.Con.ExecuteDataset(CommandType.Text, strQuery.ToString())
                Total = Server.Con.ExecuteScalar(CommandType.Text, strCountQuery.ToString())
                count = Total
                Return ds.Tables(0)
            End If

            If Server.isOracle = False Then
                Dim parameters() As Object = {query.Trim, Orden.Trim, Desde, Hasta}
                ZTrace.WriteLineIf(ZTrace.IsInfo, "Consulta de busqueda")
                ZTrace.WriteLineIf(ZTrace.IsInfo, "Query: " & query.Trim)
                ZTrace.WriteLineIf(ZTrace.IsInfo, "Orden: " & Orden.Trim)
                ZTrace.WriteLineIf(ZTrace.IsInfo, "Desde: " & Desde)
                ZTrace.WriteLineIf(ZTrace.IsInfo, "Hasta: " & Hasta)
                ds = Server.Con.ExecuteDataset("zsp_search_200_search", parameters)
            End If

            If ds.Tables.Count > 0 Then
                If ds.Tables.Count = 2 AndAlso ds.Tables(1).Rows.Count > 0 Then
                    ds.Tables(0).MinimumCapacity = ds.Tables(1).Rows(0)(0)
                End If
                Return ds.Tables(0)
            End If
            Return Nothing
        End Function

        ''' -----------------------------------------------------------------------------
        ''' <summary>
        ''' Funcion para realizar una busqueda en Zamba, devuelve un arraylist de objetos results
        ''' </summary>
        ''' <param name="DocGroup">Id del Grupo o Sector de Zamba</param>
        ''' <param name="DocType">objeto Doc_type donde se realizará la busqueda</param>
        ''' <param name="INDEXS">Vector de objetos indices con la propiedad Data y/o Datatemp cargada</param>
        ''' <param name="user">Objeto User que requiere la busqueda para el log de actividades</param>
        ''' <param name="DocTypeCount">Maxima cantidad de resultados posibles, para limitar los resultados</param>
        ''' <returns></returns>
        ''' <remarks>
        ''' </remarks>
        ''' <history>
        ''' 	[Hernan]	29/05/2006	Created
        '''     [Tomas]     30/07/2009  Modified    Se modifica la manera en que obtiene el userid de la tabla zi. Ahora se le hace
        '''                                         un inner join para obtenerlos. Se agrega una validacion para que cuando se arme 
        '''                                         la consulta concatene o no el Version=0. Esto depende del valor UseVersion del 
        '''                                         UserConfig (por defecto viene en False).
        '''     [Javier]    01/10/2010  Modified    Se aplican cambios para las restricciones
        '''     [Javier]    12/10/2010  Modified    Se coloca las restricciones dentro del primer where ya que si no había permisos
        '''                                         la consulta fallaba
        ''' </history>
        ''' -----------------------------------------------------------------------------
        Public Overloads Function SearchRowsAsocForm(ByVal DocType As DocType, ByVal Indexs As Generic.List(Of IIndex), ByVal CurrentUserId As Int64, ByVal LastPage As Int64, ByVal PageSize As Int32, ByVal doc_id As Int64, ByVal currentUserName As String) As DataTable


            Dim UP As New UserPreferences
            Dim RF As New Results_Factory

            Dim strTableI As String = MakeTable(DocType.ID, TableType.Indexs)
            Dim strTableT As String = MakeTable(DocType.ID, TableType.Document)
            Dim MainJoin As String = String.Format("{0} T inner join {1} I on T.doc_id = I.doc_id", strTableT, strTableI)

            Dim ZOPT As New ZOptBusiness
            Dim FlagCase As Boolean = Boolean.Parse(ZOPT.GetValue("CaseSensitive"))
            Dim i As Integer
            Dim Valuestring As New System.Text.StringBuilder
            Dim ColumCondstring As New System.Text.StringBuilder
            Dim First As Boolean = True
            Dim Orderstring As New System.Text.StringBuilder
            Dim dateDeclarationString As New System.Text.StringBuilder
            Dim RestrictionString As New System.Text.StringBuilder

            Dim SearchsEntities As New List(Of Int64)
            SearchsEntities.Add(DocType.ID)


            Try
                If Cache.DocTypesAndIndexs.hsRestrictionsIndexs.ContainsKey(CurrentUserId & "-" & DocType.ID) = False Then
                    Dim RMF As New RestrictionsMapper_Factory
                    Cache.DocTypesAndIndexs.hsRestrictionsIndexs.Add(CurrentUserId & "-" & DocType.ID, RMF.GetRestrictionIndexs(CurrentUserId, DocType.ID))
                    RMF = Nothing
                End If

                Dim indRestriction As Generic.List(Of IIndex) = Cache.DocTypesAndIndexs.hsRestrictionsIndexs.Item(CurrentUserId & "-" & DocType.ID)

                For i = 0 To Indexs.Count - 1
                    createWhereSearch(DocType.ID, Valuestring, Indexs, i, FlagCase, ColumCondstring, Orderstring, First, dateDeclarationString, String.Empty, SearchsEntities)
                Next

                For i = 0 To indRestriction.Count - 1
                    'createWhereSearch(Valuestring, indRestriction, i, FlagCase, RestrictionString, Orderstring, First, dateDeclarationString, False)
                    createWhereSearch(DocType.ID, Valuestring, indRestriction, i, FlagCase, RestrictionString, Orderstring, First, dateDeclarationString, DocType.ID.ToString, SearchsEntities)
                Next

                Orderstring.Append(" doc_id asc ")

                Dim strselect As System.Text.StringBuilder
                Dim strPREselect As New StringBuilder
                Dim strPOSTselect As New StringBuilder

                Dim search As ISearch = New Zamba.Core.Searchs.Search()
                search.SearchType = SearchTypes.AsociatedSearch
                search.UserId = CurrentUserId
                Dim IB As New IndexsBusiness
                Dim DTIndexs As New List(Of IIndex)
                ' If search.SearchType <> SearchTypes.AsignedTasks Then
                Indexs = IB.FilterIndexsByUserRights(DocType.ID, CurrentUserId, DocType.Indexs, RightsType.TaskGridIndexView)
                ' End If
                createSelectSearch(DocType, DTIndexs, True, Orderstring.ToString(), search, strselect, strPREselect, strPOSTselect)


                'Versiones
                If Boolean.Parse(UP.getValue("UseVersion", UPSections.UserPreferences, False, search.UserId)) Then
                    If ColumCondstring.Length > 0 Then
                        ColumCondstring.Remove(ColumCondstring.Length - 1, 1)
                        ColumCondstring.Append(" And Version = 0)")
                    Else
                        ColumCondstring.Append(" Version = 0")
                    End If
                End If

                Dim SubQueryClose As New StringBuilder
                SubQueryClose.Append(") as Q")

                InsertFilterRestrictionConditionString(DocType, ColumCondstring, SubQueryClose, CurrentUserId, strselect, dateDeclarationString, False, RestrictionString)

                Dim arraySustIndex As New ArrayList
                First = True

                i = 0
                Dim dt As DataTable = New DataTable
                strselect.Append(" And doc_id <> ")
                strselect.Append(doc_id)
                Dim Count As Int64
                dt = GetTaskTable(strselect, strPREselect, strPOSTselect, Orderstring.ToString, PageSize, LastPage, search, Count)

                Return dt
            Catch ex As Exception
                ZClass.raiseerror(ex)
            Finally
                Valuestring = Nothing
                ColumCondstring = Nothing
                Orderstring = Nothing
                UP = Nothing
                RF = Nothing
            End Try
            Return Nothing
        End Function

        ''' <summary>
        ''' Armado del select que se utiliza para las busquedas
        ''' </summary>
        ''' <param name="strTable">Nombre de la tabla. Ej: doc58</param>
        ''' <param name="Indexs">Indices que se van a traer</param>
        ''' <returns>Stringbuilder con la consulta</returns>
        ''' <history>   Marcelo    Created     20/08/09</history>
        ''' <remarks></remarks>
        'Private Function createSelectSearchAsocForm(DocTypeId As Int64, ByVal Indexs As List(Of IIndex), ByRef strselect As StringBuilder, ByRef strPREselect As StringBuilder, ByRef strPOSTselect As StringBuilder)

        '    Dim strTableI As String = MakeTable(DocTypeId, TableType.Indexs)
        '    Dim strTableT As String = MakeTable(DocTypeId, TableType.Document)
        '    Dim MainJoin As String = String.Format(" inner join {0} T on T.doc_id = I.doc_id", strTableT)


        '    Dim auIndex As New List(Of Int64)
        '    strselect.Append("Select * from (SELECT ")
        '    strselect.Append("T.DOC_ID, ")
        '    strselect.Append("T.DISK_GROUP_ID,PLATTER_ID,VOL_ID,DOC_FILE,OFFSET,")
        '    strselect.Append("T.DOC_TYPE_ID, ")
        '    strselect.Append("T.NAME as ")
        '    strselect.Append(Chr(34))
        '    strselect.Append("Nombre")
        '    strselect.Append(Chr(34))
        '    strselect.Append(",")
        '    strselect.Append("T.ICON_ID,SHARED,ver_Parent_id,RootId,")
        '    If Server.isOracle Then
        '        strselect.Append("get_filename(original_Filename)")
        '    Else
        '        strselect.Append("REVERSE(SUBSTRING(REVERSE(original_Filename), 0, CHARINDEX('\', REVERSE(original_Filename))))")
        '    End If
        '    strselect.Append(" as ")
        '    strselect.Append(Chr(34))
        '    strselect.Append("Original")
        '    strselect.Append(Chr(34))
        '    strselect.Append(",Version, NumeroVersion")
        '    strselect.Append(",disk_Vol_id, DISK_VOL_PATH, doc_type_name as ")
        '    strselect.Append(Chr(34))
        '    strselect.Append("Entidad")
        '    strselect.Append(Chr(34))
        '    strselect.Append(", crdate as ")
        '    strselect.Append(Chr(34))
        '    strselect.Append("Creado")
        '    strselect.Append(Chr(34))
        '    strselect.Append(", lupdate as ")
        '    strselect.Append(Chr(34))
        '    strselect.Append("Modificado")
        '    strselect.Append(Chr(34))

        '    strselect.Append(", User_Asigned as ")
        '    strselect.Append(Chr(34))
        '    strselect.Append("Asignado")
        '    strselect.Append(Chr(34))
        '    strselect.Append(", Task_State_ID as ")
        '    strselect.Append(Chr(34))
        '    strselect.Append(GridColumns.SITUACION_COLUMNNAME)
        '    strselect.Append(Chr(34))
        '    strselect.Append(", Do_State_ID as ")
        '    strselect.Append(Chr(34))
        '    strselect.Append("Estado")
        '    strselect.Append(Chr(34))

        '    For Each _Index As Index In Indexs
        '        strselect.Append(",")
        '        strselect.Append("I.I")
        '        strselect.Append(_Index.ID)
        '        If _Index.DropDown = IndexAdditionalType.AutoSustitución OrElse _Index.DropDown = IndexAdditionalType.AutoSustituciónJerarquico Then
        '            strselect.Append(", slst_s" & _Index.ID & ".descripcion")
        '            auIndex.Add(_Index.ID)
        '        End If
        '        strselect.Append(" as ")
        '        strselect.Append(Chr(34))
        '        strselect.Append(_Index.Name)
        '        strselect.Append(Chr(34))
        '    Next
        '    strselect.Append(" FROM ")
        '    strselect.Append(MainJoin)
        '    strselect.Append(" inner join doc_type on doc_type.doc_type_id = ")
        '    strselect.Append("T.doc_type_id left outer join disk_Volume on disk_Vol_id=vol_id ")

        '    If auIndex.Count > 0 Then
        '        For Each indiceID As Int64 In auIndex
        '            strselect.Append(" left join slst_s" & indiceID & " on I.i" & indiceID & " = slst_s" & indiceID & ".codigo ")
        '        Next
        '    End If

        '    'realizo un inner join con la WFdocument para agregar las
        '    'columnas faltantes al realizar busquedas en tareas
        '    strselect.Append("left join wfdocument wd ON ")
        '    strselect.Append("T.DOC_ID = wd.DOC_ID")

        '    auIndex = Nothing
        '    Return strselect
        'End Function


        Public Function MakeTable(ByVal docTypeId As Integer, ByVal tableType As TableType) As String
            Dim TableName As String = String.Empty

            Select Case tableType
                Case Core.TableType.Full
                    TableName = "Doc" & docTypeId.ToString
                Case Core.TableType.Document
                    TableName = "Doc_T" & docTypeId.ToString
                Case Core.TableType.Indexs
                    TableName = "Doc_I" & docTypeId.ToString
                Case Core.TableType.Blob
                    TableName = "Doc_B" & docTypeId.ToString
            End Select

            Return TableName
        End Function

        ''' -----------------------------------------------------------------------------
        ''' <summary>
        ''' Funcion para realizar una busqueda en Zamba, devuelve un arraylist de objetos results
        ''' </summary>
        ''' <param name="DocGroup">Id del Grupo o Sector de Zamba</param>
        ''' <param name="DocType">objeto Doc_type donde se realizará la busqueda</param>
        ''' <param name="INDEXS">Vector de objetos indices con la propiedad Data y/o Datatemp cargada</param>
        ''' <param name="user">Objeto User que requiere la busqueda para el log de actividades</param>
        ''' <param name="DocTypeCount">Maxima cantidad de resultados posibles, para limitar los resultados</param>
        ''' <returns></returns>
        ''' <remarks>
        ''' </remarks>
        ''' <history>
        ''' 	[Hernan]	29/05/2006	Created
        '''     [Tomas]     30/07/2009  Modified    Se modifica la manera en que obtiene el userid de la tabla zi. Ahora se le hace
        '''                                         un inner join para obtenerlos. Se agrega una validacion para que cuando se arme 
        '''                                         la consulta concatene o no el Version=0. Esto depende del valor UseVersion del 
        '''                                         UserConfig (por defecto viene en False).
        '''     [Javier]    01/10/2010  Modified    Se aplican cambios para las restricciones
        '''     [Javier]    12/10/2010  Modified    Se coloca las restricciones dentro del primer where ya que si no había permisos
        '''                                         la consulta fallaba
        ''' </history>
        ''' -----------------------------------------------------------------------------
        Public Overloads Function SearchRows(ByVal DocType As DocType,
                                             ByVal Indexs As List(Of IIndex),
                                             ByVal CurrentUserId As Int64,
                                             ByVal LastPage As Int64,
                                             ByVal PageSize As Int32,
                                             ByVal UseFilters As Boolean,
                                             ByVal SearchsEntities As List(Of Int64),
                                             ByVal DtoOnly As Boolean,
                                             ByVal UserId As Int64,
                                             ByVal OrderBy As String,
                                             ByVal Filters As List(Of ikendoFilter),
                                             ByVal search As ISearch,
                                             ByRef Count As Int64) As DataTable


            Dim RF As New Results_Factory

            Dim strTableI As String
            Dim strTableT As String
            Dim MainJoin As String

            'If (search.SearchType = SearchTypes.AsignedTasks) Then
            'Else
            strTableI = MakeTable(DocType.ID, TableType.Indexs)
            strTableT = MakeTable(DocType.ID, TableType.Document)
            MainJoin = String.Format("{0} T inner join {1} I on T.doc_id = I.doc_id", strTableT, strTableI)
            ' End If


            Dim UP As New UserPreferences
            Dim UB As New UserBusiness
            Dim ZOPT As New ZOptBusiness
            Dim FlagCase As Boolean = Boolean.Parse(ZOPT.GetValue("CaseSensitive"))
            Dim i As Integer
            Dim Valuestring As New System.Text.StringBuilder
            Dim ColumCondstring As New System.Text.StringBuilder
            Dim First As Boolean = True
            Dim Orderstring As New System.Text.StringBuilder
            Dim dateDeclarationString As New System.Text.StringBuilder
            Dim RestrictionString As New System.Text.StringBuilder
            Valuestring.Append("")
            Orderstring.Append(OrderBy)
            Try
                Dim RmF As New RestrictionsMapper_Factory
                Dim indRestriction As New List(Of IIndex)
                ' If search.SearchType <> SearchTypes.AsignedTasks Then
                If Cache.DocTypesAndIndexs.hsRestrictionsIndexs.ContainsKey(CurrentUserId & "-" & DocType.ID) = False Then
                    SyncLock Cache.DocTypesAndIndexs.hsRestrictionsIndexs
                        If Cache.DocTypesAndIndexs.hsRestrictionsIndexs.ContainsKey(CurrentUserId & "-" & DocType.ID) = False Then
                            Cache.DocTypesAndIndexs.hsRestrictionsIndexs.Add(CurrentUserId & "-" & DocType.ID, RmF.GetRestrictionIndexs(CurrentUserId, DocType.ID))
                        End If
                    End SyncLock
                End If

                indRestriction = Cache.DocTypesAndIndexs.hsRestrictionsIndexs.Item(CurrentUserId & "-" & DocType.ID)

                If Not search.Restriction Is Nothing AndAlso search.Restriction <> String.Empty Then
                    indRestriction.Add(RmF.GetRestrictionIndexs(CurrentUserId, DocType.ID, Int64.Parse(search.Restriction)))
                End If
                RmF = Nothing


                Dim IB As New IndexsBusiness

                Dim OrderInternalString As String = ResolveOrderString(Orderstring)

                ' If search.SearchType <> SearchTypes.AsignedTasks Then
                'Primero el where porque si se ordena por indice lo hace desde aca
                Dim whereQuery As StringBuilder = CreateWhere(DocType, Indexs, Valuestring, FlagCase, ColumCondstring, Orderstring, First, dateDeclarationString, SearchsEntities, indRestriction, RestrictionString, UserId, Filters)
                'End If

                Dim strselect As New StringBuilder
                Dim strPREselect As New StringBuilder
                Dim strPOSTselect As New StringBuilder

                Dim DTIndexs As New List(Of IIndex)
                ' If search.SearchType <> SearchTypes.AsignedTasks Then
                DTIndexs = IB.FilterIndexsByUserRights(DocType.ID, CurrentUserId, DocType.Indexs, RightsType.TaskGridIndexView)
                'End If
                createSelectSearch(DocType, DTIndexs, DtoOnly, OrderInternalString, search, strselect, strPREselect, strPOSTselect)
                IB = Nothing
                If Server.isOracle <> False Then
                    If String.IsNullOrEmpty(Orderstring.ToString()) Then
                        Orderstring.Append(" I.doc_id desc ")
                    End If
                Else
                    If String.IsNullOrEmpty(Orderstring.ToString()) Then
                        Orderstring.Append(" doc_id desc ")
                    End If
                End If


                'Versiones
                If Boolean.Parse(UP.getValue("UseVersion", UPSections.UserPreferences, False, Membership.MembershipHelper.CurrentUser.ID)) Then
                    If ColumCondstring.Length > 0 Then
                        ColumCondstring.Remove(ColumCondstring.Length - 1, 1)
                        ColumCondstring.Append(" AND Version = 0)")
                    Else
                        ColumCondstring.Append(" Version = 0")
                    End If
                End If

                'If search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(search.UserId) Then
                '    If ColumCondstring.Length > 0 Then
                '        ColumCondstring.Append(" AND")
                '    End If
                '    ColumCondstring.Append(String.Format(" User_Asigned = {0} ", search.UserId))
                'End If

                Dim SubQueryClose As New StringBuilder
                InsertFilterRestrictionConditionString(DocType, ColumCondstring, SubQueryClose, CurrentUserId, strselect, dateDeclarationString, UseFilters, RestrictionString)

                Dim arraySustIndex As New ArrayList
                First = True

                i = 0
                Dim dt As DataTable = New DataTable
                dt = GetTaskTable(strselect, strPREselect, strPOSTselect, Orderstring.ToString, PageSize, LastPage, search, Count)

                Return dt
            Catch ex As Exception
                ZClass.raiseerror(ex)
            Finally
                Valuestring = Nothing
                ColumCondstring = Nothing
                Orderstring = Nothing
                UP = Nothing
                UB = Nothing
                RF = Nothing
            End Try
            Return Nothing
        End Function

        Private Function ResolveOrderString(orderstring As StringBuilder) As String
            If orderstring IsNot Nothing AndAlso Not String.IsNullOrEmpty(orderstring.ToString) Then
                Dim tempOrderStr = orderstring.ToString
                orderstring.Clear()

                ' la columna por la que se ordena viene entre comillas
                Dim column As String = tempOrderStr.Substring(0, (tempOrderStr.LastIndexOf("""") + 1)).Replace("""", String.Empty)
                Dim op As String = tempOrderStr.Substring(tempOrderStr.LastIndexOf("""") + 1)

                Dim IndID As Int64 = IndexsBusiness.GetIndexIdByName(column)
                If IndID > 0 Then
                    Dim IB As New IndexsBusiness()
                    Dim index As Index = IB.getIndex(IndID)
                    If index.DropDown = IndexAdditionalType.AutoSustitución OrElse index.DropDown = IndexAdditionalType.AutoSustituciónJerarquico Then
                        column = "slst_s" & index.ID & ".descripcion"
                    Else
                        ' column = "I.I" & index.ID
                        tempOrderStr = "I.I" & index.ID & " " & op
                    End If
                Else
                    column = GridColumns.GetColumnNameByAliasName(column)
                End If

                If Zamba.Servers.Server.isOracle Then
                    orderstring.Append("""")
                    orderstring.Append(column)
                    orderstring.Append("""")
                Else
                    orderstring.Append("[")
                    orderstring.Append(column)
                    orderstring.Append("]")

                End If
                orderstring.Append(op)

                Return tempOrderStr
            End If
            Return String.Empty
        End Function

        Private Function CreateWhere(ByVal DocType As DocType,
                                     ByVal Indexs As Generic.List(Of IIndex),
                                     ByRef Valuestring As StringBuilder,
                                     ByRef FlagCase As Boolean,
                                     ByRef ColumCondstring As StringBuilder,
                                     ByRef Orderstring As StringBuilder,
                                     ByRef First As Boolean,
                                     ByRef dateDeclarationString As StringBuilder,
                                     ByVal SearchsEntities As List(Of Int64),
                                     ByRef indRestriction As Generic.List(Of IIndex),
                                     ByRef RestrictionString As StringBuilder,
                                     ByVal UserId As Int64,
                                     ByVal Filters As List(Of ikendoFilter)) As StringBuilder

            If Not Indexs Is Nothing Then
                For i As Integer = 0 To Indexs.Count - 1
                    createWhereSearch(DocType.ID, Valuestring, Indexs, i, FlagCase, ColumCondstring, Orderstring, First, dateDeclarationString, DocType.ID.ToString, SearchsEntities)
                Next
            End If

            If Not indRestriction Is Nothing Then
                For i As Integer = 0 To indRestriction.Count - 1
                    createWhereSearch(DocType.ID, Valuestring, indRestriction, i, FlagCase, RestrictionString, Orderstring, First, dateDeclarationString, DocType.ID.ToString, SearchsEntities)
                Next
            End If



            If Not Filters Is Nothing Then
                For Each kf As ikendoFilter In Filters
                    createKFilterWhereSearch(DocType.ID, Valuestring, Indexs, FlagCase, ColumCondstring, Orderstring, First, dateDeclarationString, DocType.ID.ToString, SearchsEntities, kf)
                Next
            End If

            'Se comentan estas lineas (698 a 723), ya que filtra los resultados de una entidad por los datos en otra asociada, cosa que no corresponde.

            'Se agrega al where de la busqueda de la Entidad, el subquery que filtra la entidad por las entidades asociadas en la misma busqueda, con el Join de la asociacion de esas entidades
            'Dim AssociatedEntities As List(Of Asociados) = DocAsociatedBusiness.getDocTypesAsociated(DocType.ID, UserId)
            'Dim StrAssociatedEntitiesQuery As New StringBuilder

            'Dim separator As String = " AND "
            'If ColumCondstring.Length > 0 Then
            '    ColumCondstring.Append(separator)
            'End If

            'Dim q As Int16 = 0
            'For Each Associated As Asociados In AssociatedEntities
            '    If SearchsEntities.Contains(Associated.DocTypeId2) AndAlso Associated.DocTypeId2 <> Associated.DocTypeId1 Then
            '        If q > 0 Then StrAssociatedEntitiesQuery.Append(separator)
            '        q += 1
            '        StrAssociatedEntitiesQuery.Append(Associated.Index1.Column)
            '        StrAssociatedEntitiesQuery.Append(" in (select ")
            '        StrAssociatedEntitiesQuery.Append(Associated.Index2.Column)
            '        StrAssociatedEntitiesQuery.Append(" from doc_i")
            '        StrAssociatedEntitiesQuery.Append(Associated.DocTypeId2)
            '        StrAssociatedEntitiesQuery.Append(") ")
            '    End If
            'Next
            'ColumCondstring.Append(StrAssociatedEntitiesQuery.ToString())
            'Remuevo " AND " final en caso de que haya quedado
            'If ColumCondstring.Length > 0 AndAlso ColumCondstring.ToString().Substring(Len(ColumCondstring.ToString()) - separator.Length) = separator Then
            '    ColumCondstring.Remove(ColumCondstring.Length - separator.Length, separator.Length)
            'End If

            Return ColumCondstring
        End Function

        ''' <summary>
        ''' 
        ''' </summary>
        ''' <param name="DocType"></param>
        ''' <param name="ColumCondstring"></param>
        ''' <param name="Orderstring"></param>
        ''' <param name="CurrentUserId"></param>
        ''' <param name="FC"></param>
        ''' <param name="strselect"></param>
        ''' <param name="dateDeclarationString"></param>
        ''' <param name="UseFilters"></param>
        ''' <param name="IsTask"></param>
        ''' <returns></returns>
        ''' <remarks></remarks>
        ''' <history>
        ''' 		                    Created      
        '''     [Javier]    01/10/2010  Modified    Se aplican cambios para las restricciones, las restricciones son aplicadas en 
        '''                                         search_row
        '''     [Javier]    08/10/2010  Modified    Se coloca las restricciones dentro de la primer consulta
        ''' </history>
        ''' -----------------------------------------------------------------------------
        Private Function InsertFilterRestrictionConditionString(ByVal DocType As DocType, ByVal ColumCondstring As StringBuilder, ByVal Orderstring As StringBuilder, ByVal CurrentUserId As Long, ByRef strselect As StringBuilder, ByRef dateDeclarationString As StringBuilder, ByVal UseFilters As Boolean, ByVal RestrictionString As StringBuilder) As String

            If CurrentUserId > 0 Then
                If RestrictionString.Length > 0 Then
                    If (strselect.ToString.Contains("WHERE")) Then
                        strselect.Append(" and ")
                    Else
                        strselect.Append(" WHERE ")
                    End If
                    strselect.Append(RestrictionString.ToString)
                End If

                strselect.Append(" " & Orderstring.ToString)

                Dim FilterString As String = strselect.ToString
                Dim lastWhere As Integer = FilterString.LastIndexOf("where", StringComparison.CurrentCultureIgnoreCase)
                Dim hayWhere As Boolean = lastWhere > -1 And Not FilterString.EndsWith(") as Q") And lastWhere > FilterString.LastIndexOf("SQDRead", StringComparison.CurrentCultureIgnoreCase)
                FilterString = String.Empty

                If ColumCondstring.Length > 0 Then
                    If hayWhere Then
                        strselect.Append(" AND ")
                    Else
                        strselect.Append(" WHERE ")
                        hayWhere = True
                    End If
                    strselect.Append(ColumCondstring.ToString)
                End If

                If FilterString.Length > 0 Then
                    If Not hayWhere Then
                        strselect.Append(" WHERE ")
                        hayWhere = True
                    Else
                        strselect.Append(" AND ")
                    End If
                    strselect.Append(FilterString.ToString)
                End If

                If dateDeclarationString.Length > 0 Then
                    'Si existe declaracion de variables de fecha las inserta al inicio del select
                    strselect.Insert(0, dateDeclarationString)
                End If
            End If

        End Function

        ''' <summary>
        ''' Arma la fila
        ''' </summary>
        ''' <param name="First"></param>
        ''' <param name="ArraySustIndex"></param>
        ''' <param name="dr"></param>
        ''' <param name="dt"></param>
        ''' <param name="indexs"></param>
        ''' <remarks></remarks>
        Private Sub CreateRow(ByRef ArraySustIndex As ArrayList, ByRef dr As DataRow, ByVal indexs As List(Of IIndex), Optional ByVal IsFolDerSearch As Boolean = False)
            Dim intCounter As Int32 = 0
            Dim ASB As New AutoSubstitutionBusiness
            If IsFolDerSearch Then dr("nombre") = "(Carpeta) - " & dr("nombre")
            For Each indice As IIndex In indexs
                If indice.DropDown = IndexAdditionalType.AutoSustitución OrElse indice.DropDown = IndexAdditionalType.AutoSustituciónJerarquico Then
                    ArraySustIndex.Add(indice)
                    If dr.Table.Columns.Contains(indice.Name) = False Then dr.Table.Columns.Add(indice.Name)

                    If Not IsDBNull(dr.Item("I" & indice.ID)) Then
                        dr.Item(indice.Name) = ASB.getDescription(dr.Item("I" & indice.ID), indice.ID, False, indice.Type)
                    Else
                        dr.Item(indice.Name) = String.Empty
                    End If
                End If
            Next
            ASB = Nothing
        End Sub

        ''Castea el tipo de un índice a Type
        Private Function GetIndexType(ByVal iType As IndexDataType) As Type
            Dim indexType As Type

            Select Case iType
                Case IndexDataType.Alfanumerico
                    indexType = GetType(String)
                Case IndexDataType.Alfanumerico_Largo
                    indexType = GetType(String)
                Case IndexDataType.Fecha
                    indexType = GetType(Date)
                Case IndexDataType.Fecha_Hora
                    indexType = GetType(DateTime)
                Case IndexDataType.Moneda
                    indexType = GetType(Decimal)
                Case IndexDataType.None
                    indexType = GetType(String)
                Case IndexDataType.Numerico
                    indexType = GetType(Int64)
                Case IndexDataType.Numerico_Decimales
                    indexType = GetType(Decimal)
                Case IndexDataType.Numerico_Largo
                    indexType = GetType(Decimal)
                Case IndexDataType.Si_No
                    indexType = GetType(String)
                Case Else
                    indexType = GetType(String)
            End Select

            Return indexType
        End Function


        Private Sub createWhereSearch(EntityId As Int64, ByRef sbValue As StringBuilder, ByVal Indexs As Generic.List(Of IIndex), ByRef i As Int64, ByRef FlagCase As Boolean, ByRef ColumCondstring As StringBuilder, ByRef Orderstring As StringBuilder, ByRef First As Boolean, ByRef dateDeclarationString As StringBuilder, ByVal tablePrefix As String, ByVal SearchsEntities As List(Of Int64))
            Dim mainVal As Object = Nothing
            Dim tempVal As Object = Nothing
            Dim sbDate As New StringBuilder
            Dim indexColName As String

            Dim separator As String = " AND "

            sbValue.Remove(0, sbValue.Length)
            'sbValue.Append(Indexs(i).Data)

            If String.IsNullOrEmpty(tablePrefix) Then
                indexColName = "[" & Indexs(i).Name & "]"
            Else
                Dim Ind As Zamba.Core.Index = Indexs(i)
                Select Case Indexs(i).DropDown
                    Case IndexAdditionalType.AutoSustitución, IndexAdditionalType.AutoSustituciónJerarquico
                        If Ind.[Operator] <> "=" OrElse Ind.Data.Length = 0 Then
                            'En busqueda global web se usa [Data] para guardar valores
                            Dim dd As String = IIf(Ind.dataDescription = String.Empty, Ind.Data, Ind.dataDescription)
                            sbValue.Append(dd)
                            indexColName = "SLST_S" & Ind.ID.ToString & ".DESCRIPCION"
                        Else
                            sbValue.Append(Indexs(i).Data)
                            indexColName = "I.I" & Ind.ID.ToString
                        End If

                    Case Else
                        sbValue.Append(Indexs(i).Data)
                        indexColName = "I.I" & Ind.ID.ToString
                End Select
            End If

            If sbValue.Length > 0 OrElse Indexs(i).[Operator].ToLower = "es nulo" Then
                If Indexs(i).[Operator] <> "SQL" AndAlso Not sbValue.ToString.StartsWith("select ", True, Nothing) Then
                    If sbValue.ToString.Split(";").Length > 1 Then
                        If Indexs(i).Type = IndexDataType.Alfanumerico OrElse
                        Indexs(i).Type = IndexDataType.Alfanumerico_Largo Then
                            FlagCase = True
                            mainVal = "'" & LCase(sbValue.Replace(";", "';'").ToString) & "'"
                        End If
                    Else
                        Select Case Indexs(i).Type
                            Case IndexDataType.Numerico, IndexDataType.Numerico_Largo
                                If sbValue.Length <> 0 Then
                                    If Indexs(i).DropDown = IndexAdditionalType.AutoSustitución OrElse Indexs(i).DropDown = IndexAdditionalType.AutoSustituciónJerarquico Then
                                        mainVal = "'" & sbValue.ToString & "'"
                                    Else
                                        mainVal = Int64.Parse(sbValue.ToString)
                                    End If
                                End If

                            Case IndexDataType.Numerico_Decimales, IndexDataType.Moneda
                                If sbValue.Length <> 0 Then
                                    If System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator = "," Then
                                        sbValue = sbValue.Replace(".", ",")
                                    End If
                                    mainVal = CDec(sbValue.ToString)
                                    mainVal = mainVal.ToString.Replace(",", ".")
                                End If

                            Case IndexDataType.Si_No
                                If sbValue.Length <> 0 Then
                                    mainVal = Int64.Parse(sbValue.ToString)
                                End If

                            Case IndexDataType.Fecha, IndexDataType.Fecha_Hora
                                If Not String.IsNullOrEmpty(sbValue.ToString.Trim) Then
                                    If Server.isSQLServer Then
                                        mainVal = "@fecdesde" & Indexs(i).Column
                                        sbDate.Append("declare " & mainVal & " datetime ")
                                        If Indexs(i).Type = IndexDataType.Fecha Then
                                            sbDate.Append("set " & mainVal & " = " & Server.Con.ConvertDate(sbValue.ToString) & " ")
                                        Else
                                            sbDate.Append("set " & mainVal & " = " & Server.Con.ConvertDateTime(sbValue.ToString) & " ")
                                        End If
                                        dateDeclarationString.Append(sbDate)
                                    Else
                                        If Indexs(i).Type = IndexDataType.Fecha Then
                                            mainVal = Server.Con.ConvertDate(sbValue.ToString)
                                        Else
                                            mainVal = Server.Con.ConvertDateTime(sbValue.ToString)
                                        End If
                                    End If
                                End If

                            Case IndexDataType.Alfanumerico, IndexDataType.Alfanumerico_Largo
                                If FlagCase Then
                                    mainVal = "'" & LCase(sbValue.ToString) & "'"
                                Else
                                    mainVal = "'" & sbValue.ToString & "'"
                                End If
                        End Select
                    End If
                Else
                    mainVal = Indexs(i).Data
                End If

                Dim Op As String = mainVal.ToString
                If Op.Contains("''") Then Op = Op.Replace("''", "'")
                mainVal = Op
                Op = String.Empty
                If MisTareasSinFiltro = False Then

                    If ColumCondstring.Length > 0 Then
                        ColumCondstring.Append(separator)
                    End If

                    Select Case Indexs(i).[Operator].ToLower()
                        Case "="
                            Op = "="
                            If FlagCase AndAlso (Indexs(i).Type = IndexDataType.Alfanumerico OrElse Indexs(i).Type = IndexDataType.Alfanumerico_Largo) AndAlso (IsNumeric(Results_Business.ReplaceChar(mainVal)) = False) Then
                                ColumCondstring.Append(" (lower(" & indexColName & ")=(" & LCase(mainVal) & ")) ")
                            Else

                                ColumCondstring.Append(" (" & indexColName & "=(" & mainVal & ")) ")
                            End If

                        Case "<>"
                            Op = "<>"
                            ColumCondstring.Append(" (" & indexColName & "<>(" & mainVal & ") or " & indexColName & " is null) ")

                        Case ">", "<", ">=", "<="
                            Op = Indexs(i).[Operator]
                            ColumCondstring.Append(" (" & indexColName & Op & "(" & mainVal & ")) ")

                        Case "es nulo"
                            Op = "is null"
                            ColumCondstring.Append(" (" & indexColName & " is null) ")

                        Case "entre"
                            Dim Data2Added As Boolean
                            Try
                                'cambio las a como indice a I ya que todos los indices vienen con dato algunos vacio otros no.
                                Select Case Indexs(i).Type
                                    Case 1, 2, 3, 6
                                        If Not String.IsNullOrEmpty(Indexs(i).Data2) Then
                                            If Indexs(i).Type = IndexDataType.Numerico OrElse
                                        Indexs(i).Type = IndexDataType.Numerico_Largo Then
                                                tempVal = Int64.Parse(Indexs(i).Data2)
                                            Else
                                                tempVal = CDec(Indexs(i).Data2)
                                            End If
                                            Data2Added = True
                                        End If
                                    Case 4, 5
                                        If Not String.IsNullOrEmpty(Indexs(i).Data2) Then
                                            If Not String.IsNullOrEmpty(sbValue.ToString.Trim) Then
                                                If Server.isSQLServer Then
                                                    tempVal = "@fechasta" & indexColName
                                                    sbDate.Remove(0, sbDate.Length)
                                                    sbDate.Append("declare " & tempVal & " datetime ")

                                                    If Indexs(i).Type = IndexDataType.Fecha Then
                                                        sbDate.Append("set " & tempVal & " = " & Server.Con.ConvertDate(Indexs(i).Data2) & " ")
                                                    Else
                                                        sbDate.Append("set " & tempVal & " = " & Server.Con.ConvertDateTime(Indexs(i).Data2) & " ")
                                                    End If

                                                    dateDeclarationString.Append(sbDate)
                                                Else
                                                    If Indexs(i).Type = IndexDataType.Fecha Then
                                                        tempVal = Server.Con.ConvertDate(Indexs(i).Data2)
                                                    Else
                                                        tempVal = Server.Con.ConvertDateTime(Indexs(i).Data2)
                                                    End If
                                                End If
                                            End If
                                            Data2Added = True
                                        End If
                                    Case 7, 8
                                        If Not String.IsNullOrEmpty(Indexs(i).Data2) Then
                                            FlagCase = True
                                            tempVal = "'" & LCase(DirectCast(Indexs(i).Data2, String)) & "'"
                                            Data2Added = True
                                        End If
                                End Select
                            Catch ex As Exception
                                Throw New Exception("Ocurrio un error al convertir al tipo de Dato: Dato: " & sbValue.ToString & ", Tipo Dato: " & Indexs(i).Type & " " & ex.ToString)

                            End Try

                            If Data2Added = True Then
                                If Server.isSQLServer And (Indexs(i).Type = IndexDataType.Fecha OrElse Indexs(i).Type = IndexDataType.Fecha_Hora) Then
                                    ColumCondstring.Append(" (" & indexColName & " BETWEEN (" & mainVal & ") and (" & tempVal & "))")
                                Else
                                    ColumCondstring.Append(" (" & indexColName & ">=(" & mainVal & ") and " & indexColName & "<=(" & tempVal & "))")
                                End If
                                Data2Added = False
                            End If

                        Case "contiene"
                            While mainVal.Contains("  ")
                                mainVal.Replace("  ", " ")
                            End While
                            mainVal = mainVal.Trim.Replace(" ", "%")

                            If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(Replace(Trim(LCase(mainVal)), "'", String.Empty))) = False) Then
                                ColumCondstring.Append(" (lower(" & indexColName & ") Like '%" & Replace(Trim(LCase(mainVal)), "'", String.Empty) & "%')")
                            Else
                                ColumCondstring.Append(" (" & indexColName & " Like '%" & Replace(Trim(mainVal), "'", String.Empty) & "%')")
                            End If

                        Case "empieza"
                            If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(Replace(Trim(LCase(mainVal)), "'", String.Empty))) = False) Then
                                ColumCondstring.Append(" (lower(" & indexColName & ") Like '" & Replace(Trim(LCase(mainVal)), "'", String.Empty) & "%')")
                            Else
                                ColumCondstring.Append(" (" & indexColName & " Like '" & Replace(Trim(mainVal), "'", String.Empty) & "%')")
                            End If

                        Case "termina"
                            If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(Replace(Trim(LCase(mainVal)), "'", String.Empty))) = False) Then
                                ColumCondstring.Append(" (lower(" & indexColName & ") Like '%" & Replace(Trim(LCase(mainVal)), "'", String.Empty) & "')")
                            Else
                                ColumCondstring.Append(" (" & indexColName & " Like '%" & Replace(Trim(mainVal), "'", String.Empty) & "')")
                            End If

                        Case "alguno"
                            Op = "LIKE"
                            mainVal = mainVal.Replace(";", ",")
                            While mainVal.Contains("  ")
                                mainVal.Replace("  ", " ")
                            End While
                            mainVal = mainVal.Trim.Replace(" ", ",")

                            Dim SomeValues As Array = DirectCast(mainVal, String).Split(",")
                            Dim somestring As String = String.Empty
                            For x As Int32 = 0 To SomeValues.Length - 1
                                Dim Val As String = SomeValues(x)
                                If IsNothing(Val) = False AndAlso Not String.IsNullOrEmpty(Val.Trim) Then
                                    If i = 0 AndAlso x = 0 Then
                                        If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(LCase(Val).Replace("'", String.Empty))) = False) Then
                                            somestring = " (lower(" & indexColName & ") " & Op & " ('%" & LCase(Val).Replace("'", String.Empty) & "%')"
                                        Else
                                            somestring = " (" & indexColName & " " & Op & " ('%" & Val.Replace("'", String.Empty) & "%')"
                                        End If
                                    ElseIf x > 0 Then
                                        If String.IsNullOrEmpty(somestring) Then
                                            If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(Replace(LCase(Val), "'", String.Empty).Trim)) = False) Then
                                                somestring &= separator & " lower(" & DirectCast(indexColName, String) & ") " & Op & " ('%" & Replace(LCase(Val), "'", String.Empty).Trim & "%')"
                                            Else
                                                somestring &= separator & " " & DirectCast(indexColName, String) & " " & Op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                                            End If
                                        Else
                                            separator = " or "
                                            If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(Replace(LCase(Val), "'", String.Empty).Trim)) = False) Then
                                                somestring &= separator & " lower(" & indexColName & ") " & Op & " ('%" & Replace(LCase(Val), "'", String.Empty).Trim & "%')"
                                            Else
                                                somestring &= separator & " " & indexColName & " " & Op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                                            End If
                                        End If
                                    End If
                                End If
                            Next
                            If Not String.IsNullOrEmpty(somestring) Then ColumCondstring.Append(somestring & ")")
                            SomeValues = Nothing
                            somestring = Nothing

                        Case "distinto"
                            Op = "NOT LIKE"
                            mainVal = mainVal.Replace(";", ",")
                            While mainVal.Contains("  ")
                                mainVal = mainVal.Replace("  ", " ")
                            End While
                            mainVal = mainVal.Trim.Replace(" ", ",")

                            Dim SomeValues As Array = DirectCast(mainVal, String).Split(",")
                            Dim somestring As String = String.Empty
                            For x As Int32 = 0 To SomeValues.Length - 1
                                Dim Val As String = SomeValues(x)
                                If IsNothing(Val) = False AndAlso Not String.IsNullOrEmpty(Val.Trim) Then
                                    If x = 0 And i = 0 Then
                                        If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(LCase(Val).Replace("'", String.Empty))) = False) Then
                                            somestring = " (lower(" & indexColName & ") " & Op & " ('%" & LCase(Val).Replace("'", String.Empty) & "%')"
                                        Else
                                            somestring = " (" & indexColName & " " & Op & " ('%" & Val.Replace("'", String.Empty) & "%')"
                                        End If
                                    ElseIf x = 0 Then
                                        If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(LCase(Val).Replace("'", String.Empty))) = False) Then
                                            somestring = " (lower(" & indexColName & ") " & Op & " ('%" & LCase(Val).Replace("'", String.Empty) & "%')"
                                        Else
                                            somestring = " (" & indexColName & " " & Op & " ('%" & Val.Replace("'", String.Empty) & "%')"
                                        End If
                                    Else
                                        If String.IsNullOrEmpty(somestring) Then
                                            If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(Replace(LCase(Val), "'", String.Empty).Trim)) = False) Then
                                                somestring &= separator & " lower(" & DirectCast(indexColName, String) & ") " & Op & " ('%" & Replace(LCase(Val), "'", String.Empty).Trim & "%')"
                                            Else
                                                somestring &= separator & " " & DirectCast(indexColName, String) & " " & Op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                                            End If
                                        Else
                                            separator = " or "
                                            If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(Replace(LCase(Val), "'", String.Empty).Trim)) = False) Then
                                                somestring &= separator & " lower(" & indexColName & ") " & Op & " ('%" & Replace(LCase(Val), "'", String.Empty).Trim & "%')"
                                            Else
                                                somestring &= separator & " " & indexColName & " " & Op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                                            End If
                                        End If
                                    End If
                                End If
                            Next
                            If Not String.IsNullOrEmpty(somestring) Then ColumCondstring.Append(somestring & ")")
                            SomeValues = Nothing
                            somestring = Nothing

                        Case "dentro"
                            If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(LCase(mainVal))) = False) Then
                                ColumCondstring.Append(" (lower(" & indexColName & ") in (" & LCase(mainVal) & "))")
                            Else
                                ColumCondstring.Append(" (" & indexColName & " in (" & mainVal & "))")
                            End If

                        Case "sql"
                            ColumCondstring.Append(" (" & indexColName & " in (" & mainVal & "))")

                    End Select

                    Op = Nothing
                    separator = Nothing
                End If
            End If

            If Indexs(i).OrderSort = OrderSorts.ASC Then Orderstring.Append(", " & indexColName & " ASC ")
            If Indexs(i).OrderSort = OrderSorts.DESC Then Orderstring.Append(", " & indexColName & " DESC ")
        End Sub
        Private Sub createKFilterWhereSearch(EntityId As Int64, ByRef sbValue As StringBuilder, ByVal Indexs As Generic.List(Of IIndex), ByRef FlagCase As Boolean, ByRef ColumCondstring As StringBuilder, ByRef Orderstring As StringBuilder, ByRef First As Boolean, ByRef dateDeclarationString As StringBuilder, ByVal tablePrefix As String, ByVal SearchsEntities As List(Of Int64), kFilter As ikendoFilter)

            Dim tempVal As Object = Nothing
            Dim sbDate As New StringBuilder

            If (GridColumns.ZambaColumns.ContainsKey(kFilter.Field)) Then
                kFilter.DataBaseColumn = GridColumns.ZambaColumns(kFilter.Field)
                If kFilter.DataBaseColumn = "NAME" Then
                    kFilter.DataBaseColumn = "T.NAME"
                End If
            End If

            Dim separator As String = " And "

            sbValue.Remove(0, sbValue.Length)

            If ColumCondstring.Length > 0 Then
                ColumCondstring.Append(separator)
            End If

            Dim op As String = " Like "

            Select Case kFilter.Operator
                Case "eq"
                    op = "="
                    If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(kFilter.Value) = False)) Then
                        ColumCondstring.Append(" (lower(" & kFilter.DataBaseColumn & ")='" & kFilter.Value.ToLower() & "') ")
                    Else
                        ColumCondstring.Append(" (" & kFilter.DataBaseColumn & "='" & kFilter.Value & "') ")
                    End If
                Case "neq"
                    op = "<>"
                    ColumCondstring.Append(" (" & kFilter.DataBaseColumn & "<>(" & kFilter.Value & ") or " & kFilter.DataBaseColumn & " is null) ")

                Case "gte", "gt", "lt", "lte"
                    op = kFilter.Operator.Replace("gt", ">").Replace("gte", ">=").Replace("lt", "<").Replace("lte", "<=")
                    ColumCondstring.Append(" (" & kFilter.DataBaseColumn & op & "(" & kFilter.Value & ")) ")

                Case "isnull"
                    op = "is null"
                    ColumCondstring.Append(" (" & kFilter.DataBaseColumn & " is null) ")

                'Case "Entre"
                '    Dim Data2Added As Boolean
                '    Try
                '        'cambio las a como indice a I ya que todos los indices vienen con dato algunos vacio otros no.
                '        Select Case Indexs(i).Type
                '            Case 1, 2, 3, 6
                '                If Not String.IsNullOrEmpty(Indexs(i).Data2) Then
                '                    If Indexs(i).Type = IndexDataType.Numerico OrElse
                '                        Indexs(i).Type = IndexDataType.Numerico_Largo Then
                '                        tempVal = Int64.Parse(Indexs(i).Data2)
                '                    Else
                '                        tempVal = CDec(Indexs(i).Data2)
                '                    End If
                '                    Data2Added = True
                '                End If
                '            Case 4, 5
                '                If Not String.IsNullOrEmpty(Indexs(i).Data2) Then
                '                    If Not String.IsNullOrEmpty(sbValue.ToString.Trim) Then
                '                        If Server.isSQLServer Then
                '                            tempVal = "@fechasta" & kFilter.DataBaseColumn
                '                            sbDate.Remove(0, sbDate.Length)
                '                            sbDate.Append("declare " & tempVal & " datetime ")

                '                            If Indexs(i).Type = IndexDataType.Fecha Then
                '                                sbDate.Append("set " & tempVal & " = " & Server.Con.ConvertDate(Indexs(i).Data2) & " ")
                '                            Else
                '                                sbDate.Append("set " & tempVal & " = " & Server.Con.ConvertDateTime(Indexs(i).Data2) & " ")
                '                            End If

                '                            dateDeclarationString.Append(sbDate)
                '                        Else
                '                            If Indexs(i).Type = IndexDataType.Fecha Then
                '                                tempVal = Server.Con.ConvertDate(Indexs(i).Data2)
                '                            Else
                '                                tempVal = Server.Con.ConvertDateTime(Indexs(i).Data2)
                '                            End If
                '                        End If
                '                    End If
                '                    Data2Added = True
                '                End If
                '            Case 7, 8
                '                If Not String.IsNullOrEmpty(Indexs(i).Data2) Then
                '                    FlagCase = True
                '                    tempVal = "'" & LCase(DirectCast(Indexs(i).Data2, String)) & "'"
                '                    Data2Added = True
                '                End If
                '        End Select
                '    Catch ex As Exception
                '        Throw New Exception("Ocurrio un error al convertir al tipo de Dato: Dato: " & sbValue.ToString & ", Tipo Dato: " & Indexs(i).Type & " " & ex.ToString)

                '    End Try

                '    If Data2Added = True Then
                '        If Server.isSQLServer And (Indexs(i).Type = IndexDataType.Fecha OrElse Indexs(i).Type = IndexDataType.Fecha_Hora) Then
                '            ColumCondstring.Append(" (" & kFilter.DataBaseColumn & " BETWEEN (" & kFilter.value & ") and (" & tempVal & "))")
                '        Else
                '            ColumCondstring.Append(" (" & kFilter.DataBaseColumn & ">=(" & kFilter.value & ") and " & kFilter.DataBaseColumn & "<=(" & tempVal & "))")
                '        End If
                '        Data2Added = False
                '    End If

                Case "contains"
                    While kFilter.Value.Contains("  ")
                        kFilter.Value.Replace("  ", " ")
                    End While
                    kFilter.Value = kFilter.Value.Trim.Replace(" ", "%")

                    If FlagCase AndAlso (IsNumeric(Results_Business.ReplaceChar(Replace(Trim(kFilter.Value.ToLower()), "'", String.Empty)) = False)) Then
                        ColumCondstring.Append(" (lower(" & kFilter.DataBaseColumn & ") Like '%" & Replace(Trim(kFilter.Value.ToLower()), "'", String.Empty) & "%')")
                    Else
                        ColumCondstring.Append(" (" & kFilter.DataBaseColumn & " Like '%" & Replace(Trim(kFilter.Value), "'", String.Empty) & "%')")
                    End If

                Case "startswith"
                    If FlagCase Then
                        ColumCondstring.Append(" (lower(" & kFilter.DataBaseColumn & ") Like '" & Replace(Trim(kFilter.Value.ToLower()), "'", String.Empty) & "%')")
                    Else
                        ColumCondstring.Append(" (" & kFilter.DataBaseColumn & " Like '" & Replace(Trim(kFilter.Value), "'", String.Empty) & "%')")
                    End If

                Case "endswith"
                    If FlagCase Then
                        ColumCondstring.Append(" (lower(" & kFilter.DataBaseColumn & ") Like '%" & Replace(Trim(kFilter.Value.ToLower()), "'", String.Empty) & "')")
                    Else
                        ColumCondstring.Append(" (" & kFilter.DataBaseColumn & " Like '%" & Replace(Trim(kFilter.Value), "'", String.Empty) & "')")
                    End If

                'Case "Alguno"
                '    op = "LIKE"
                '    kFilter.value = kFilter.value.Replace(";", ",")
                '    While kFilter.value.Contains("  ")
                '        kFilter.value.Replace("  ", " ")
                '    End While
                '    kFilter.value = kFilter.value.Trim.Replace(" ", ",")

                '    Dim SomeValues As Array = DirectCast(kFilter.value, String).Split(",")
                '    Dim somestring As String = String.Empty
                '    For x As Int32 = 0 To SomeValues.Length - 1
                '        Dim Val As String = SomeValues(x)
                '        If IsNothing(Val) = False AndAlso Not String.IsNullOrEmpty(Val.Trim) Then
                '            If i = 0 AndAlso x = 0 Then
                '                If FlagCase Then
                '                    somestring = " (lower(" & kFilter.DataBaseColumn & ") " & op & " ('%" & Val.Replace("'", String.Empty) & "%')"
                '                Else
                '                    somestring = " (" & kFilter.DataBaseColumn & " " & op & " ('%" & Val.Replace("'", String.Empty) & "%')"
                '                End If
                '            ElseIf x > 0 Then
                '                If String.IsNullOrEmpty(somestring) Then
                '                    If FlagCase Then
                '                        somestring &= separator & " lower(" & DirectCast(kFilter.DataBaseColumn, String) & ") " & op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                '                    Else
                '                        somestring &= separator & " " & DirectCast(kFilter.DataBaseColumn, String) & " " & op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                '                    End If
                '                Else
                '                    separator = " or "
                '                    If FlagCase Then
                '                        somestring &= separator & " lower(" & kFilter.DataBaseColumn & ") " & op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                '                    Else
                '                        somestring &= separator & " " & kFilter.DataBaseColumn & " " & op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                '                    End If
                '                End If
                '            End If
                '        End If
                '    Next
                '    If Not String.IsNullOrEmpty(somestring) Then ColumCondstring.Append(somestring & ")")
                '    SomeValues = Nothing
                '    somestring = Nothing

                Case "doesnotcontain"
                    op = "NOT LIKE"
                    kFilter.Value = kFilter.Value.Replace(";", ",")
                    While kFilter.Value.Contains("  ")
                        kFilter.Value = kFilter.Value.Replace("  ", " ")
                    End While
                    kFilter.Value = kFilter.Value.Trim.Replace(" ", ",")

                    Dim SomeValues As Array = DirectCast(kFilter.Value, String).Split(",")
                    Dim somestring As String = String.Empty
                    For x As Int32 = 0 To SomeValues.Length - 1
                        Dim Val As String = SomeValues(x)
                        If IsNothing(Val) = False AndAlso Not String.IsNullOrEmpty(Val.Trim) Then
                            If x = 0 Then
                                If FlagCase Then
                                    somestring = " (lower(" & kFilter.DataBaseColumn & ") " & op & " ('%" & Val.ToLower().Replace("'", String.Empty) & "%')"
                                Else
                                    somestring = " (" & kFilter.DataBaseColumn & " " & op & " ('%" & Val.Replace("'", String.Empty) & "%')"
                                End If
                            ElseIf x = 0 Then
                                If FlagCase Then
                                    somestring = " (lower(" & kFilter.DataBaseColumn & ") " & op & " ('%" & Val.ToLower().Replace("'", String.Empty) & "%')"
                                Else
                                    somestring = " (" & kFilter.DataBaseColumn & " " & op & " ('%" & Val.Replace("'", String.Empty) & "%')"
                                End If
                            Else
                                If String.IsNullOrEmpty(somestring) Then
                                    If FlagCase Then
                                        somestring &= separator & " lower(" & DirectCast(kFilter.DataBaseColumn, String) & ") " & op & " ('%" & Replace(Val.ToLower(), "'", String.Empty).Trim & "%')"
                                    Else
                                        somestring &= separator & " " & DirectCast(kFilter.DataBaseColumn, String) & " " & op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                                    End If
                                Else
                                    separator = " or "
                                    If FlagCase Then
                                        somestring &= separator & " lower(" & kFilter.DataBaseColumn & ") " & op & " ('%" & Replace(Val.ToLower(), "'", String.Empty).Trim & "%')"
                                    Else
                                        somestring &= separator & " " & kFilter.DataBaseColumn & " " & op & " ('%" & Replace(Val, "'", String.Empty).Trim & "%')"
                                    End If
                                End If
                            End If
                        End If
                    Next
                    If Not String.IsNullOrEmpty(somestring) Then ColumCondstring.Append(somestring & ")")
                    SomeValues = Nothing
                    somestring = Nothing

                Case "Dentro"
                    If FlagCase Then
                        ColumCondstring.Append(" (lower(" & kFilter.DataBaseColumn & ") in (" & kFilter.Value.ToLower() & "))")
                    Else
                        ColumCondstring.Append(" (" & kFilter.DataBaseColumn & " in (" & kFilter.Value & "))")
                    End If

                Case "SQL"
                    ColumCondstring.Append(" (" & kFilter.DataBaseColumn & " in (" & kFilter.Value & "))")

            End Select

            op = Nothing
            separator = Nothing


        End Sub

        Public Function IsNullString()
            If Server.isOracle Then
                Return "NVL("
            Else
                Return "IsNUll("
            End If

        End Function

        ''' <summary>
        ''' Armado del select que se utiliza para las busquedas
        ''' </summary>
        ''' <param name="strTable">Nombre de la tabla. Ej: doc58</param>
        ''' <param name="Indexs">Indices que se van a traer</param>
        ''' <returns>Stringbuilder con la consulta</returns>
        ''' <history>   Marcelo    Created     20/08/09</history>
        ''' <remarks></remarks>
        ''' 
        Dim Flagdocid As Boolean
        Private Sub createSelectSearch(docType As IDocType, ByVal Indexs As List(Of IIndex), ByVal DtoOnly As Boolean, orderBy As String, Search As ISearch, ByRef strselect As StringBuilder, ByRef strPREselect As StringBuilder, ByRef strPOSTselect As StringBuilder)

            Dim strTableI As String
            Dim strTableT As String
            Dim MainJoin As String

            'If Search.SearchType <> SearchTypes.AsignedTasks Then
            strTableI = MakeTable(docType.ID, TableType.Indexs)
            strTableT = MakeTable(docType.ID, TableType.Document)
            MainJoin = String.Format(" inner join {0} T on T.doc_id = I.doc_id", strTableT)
            'End If
            Dim auIndex As New List(Of Int64)
            'Si es Oracle el ordenamiento se resuelve acá
            'If String.IsNullOrEmpty(orderBy) OrElse Search.SearchType = SearchTypes.AsignedTasks Then
            '    orderBy = "I.Doc_Id Desc"
            'End If

            If Server.isOracle <> False Then
                If String.IsNullOrEmpty(orderBy) Then
                    orderBy = "I.Doc_Id Desc"
                End If
            Else
                If String.IsNullOrEmpty(orderBy) Then
                    orderBy = "Doc_Id Desc"
                End If
            End If

            strselect.Append("SELECT ")

            'If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then
            'strselect.Append("DOC_ID ")
            'Else


            strselect.Append("I.DOC_ID, ")
            strselect.Append("'' as THUMB ")
            If Server.isSQLServer Then
                strselect.Append(", wd.IconId as ICON_ID")
            End If

            If (DtoOnly AndAlso Server.isSQLServer) Then
                strPREselect.Append(" (LTRIM(RTRIM(DISK_VOL_PATH)) + '\' + convert(nvarchar,")
                strPREselect.Append(docType.ID & ") + '\' + convert(nvarchar,OFFSET) + '\' + LTRIM(RTRIM(DOC_FILE))) as FullPath")
            ElseIf (DtoOnly AndAlso Server.isOracle) Then
                strPREselect.Append(" (LTRIM(RTRIM(DISK_VOL_PATH)) || '\' || ")
                strPREselect.Append(docType.ID & " || '\' || OFFSET || '\' || LTRIM(RTRIM(DOC_FILE))) as FullPath")
            Else
                strPREselect.Append(" T.DISK_GROUP_ID,VOL_ID,RTRIM(LTRIM(DOC_FILE)) AS DOC_FILE,OFFSET")
            End If
            'End If

            'If Search.SearchType = SearchTypes.AsignedTasks Then
            '    strselect.Append(", DOC_TYPE_ID ")
            'Else
            strselect.Append("," & docType.ID & " as DOC_TYPE_ID ")

            '' End If

            If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then
                strselect.Append(" ,LTRIM(RTRIM(NAME)) as NAME")
            Else
                strPREselect.Append(",LTRIM(RTRIM(T.NAME)) as NAME")
            End If

            Dim concatstring As String
            If Server.isOracle Then
                concatstring = "||"
            Else
                concatstring = "+"
            End If

            If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then
            Else
                If (DtoOnly = False) Then
                    strPREselect.Append(",PLATTER_ID,SHARED,ver_Parent_id,RootId,disk_Vol_id, LTRIM(RTRIM(DISK_VOL_PATH)) AS DISK_VOL_PATH")
                    If Server.isOracle Then
                        strPREselect.Append(",get_filename(LTRIM(RTRIM(original_Filename)))")
                    Else
                        strPREselect.Append(",REVERSE(SUBSTRING(REVERSE(LTRIM(RTRIM(original_Filename))), 0, CHARINDEX('\', REVERSE(LTRIM(RTRIM(original_Filename))))))")
                    End If
                    strPREselect.Append(" as  Original ,Version, NumeroVersion")
                End If
            End If


            If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then
                strselect.Append(", ICONID as ICON_ID")
                strselect.Append(", checkin as Ingreso")
                strselect.Append(", '" & docType.Name & "' as str_ENTIDAD ")
            Else
                strPREselect.Append(", t.ICON_ID")
                strselect.Append(",'" & docType.Name & "'  as str_Entidad")
                strselect.Append(", i.crdate as Creado")
                strselect.Append(", i.lupdate as Modificado")
            End If

            ' If IsTask Then
            strselect.Append(", ")
            strselect.Append(IsNullString())
            strselect.Append("User_Asigned ")
            strselect.Append(",0) as User_Asigned")

            If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then
                'strPREselect.Append("DISTINCT ")
                strPREselect.Append(" ,NVL(U.NAME, '') As AssignedTo")
                strPREselect.Append(" ,NVL(ww.Name, '') AS Workflow")
            Else
                strPREselect.Append(" ,NVL(U.NAME, '') As AssignedTo")
                strPREselect.Append(" ,NVL(ww.Name, '') AS Workflow")
            End If

            strselect.Append(", ")
            strselect.Append(IsNullString())
            strselect.Append("Task_State_ID")
            strselect.Append(",0)  as Execution")
            strselect.Append(", ")
            strselect.Append(IsNullString())
            strselect.Append("Do_State_ID ")
            strselect.Append(",0) as Do_State_ID")
            strselect.Append(", ")
            strselect.Append(IsNullString())
            strselect.Append("wd.TASK_ID")
            strselect.Append(",0) as Task_Id")
            strselect.Append(", ")
            strselect.Append(IsNullString())
            strselect.Append("wd.STEP_ID")
            strselect.Append(",0) as STEP_ID")
            strselect.Append(", ")
            strselect.Append(IsNullString())
            strselect.Append("wd.work_id")
            strselect.Append(",0) as work_id")
            strPREselect.Append(", ")
            strPREselect.Append(IsNullString())
            strPREselect.Append("ws.Name")
            strPREselect.Append(",'')  as STEP")
            strPREselect.Append(", ")
            strPREselect.Append(IsNullString())
            strPREselect.Append("wss.Name")
            strPREselect.Append(",'')  as State")
            strPREselect.Append(", '" & docType.Name & "' as ENTIDAD ")


            'If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then
            'Else

            Dim UseIndexsRights As Boolean = (New RightsBusiness).GetUserRights(Search.UserId, ObjectTypes.DocTypes, RightsType.ViewRightsByIndex, docType.ID)

            Dim IndexsRights As Hashtable = Nothing
            If UseIndexsRights Then IndexsRights = (New UserBusiness).GetIndexsRights(docType.ID, Membership.MembershipHelper.CurrentUser.ID, True)


            For Each _Index As Index In Indexs

                If UseIndexsRights Then
                    Dim IR As IndexsRightsInfo = DirectCast(IndexsRights(_Index.ID), IndexsRightsInfo)
                    'For Each indexid As Int64 In IndexsRights.Keys
                    '    If indexid = _Index.ID Then
                    'aplica permiso Visible
                    If IR.GetIndexRightValue(RightsType.TaskGridIndexView) = True Then

                                strselect.Append(",")
                                strselect.Append("I.I")
                                strselect.Append(_Index.ID)

                                If _Index.DropDown = IndexAdditionalType.AutoSustitución OrElse _Index.DropDown = IndexAdditionalType.AutoSustituciónJerarquico Then
                                    strPREselect.Append(", slst_s" & _Index.ID & ".Descripcion")
                                    auIndex.Add(_Index.ID)
                                    strPREselect.Append(" as [")
                                    strPREselect.Append(_Index.Name)
                                    strPREselect.Append("]")
                                End If

                                If _Index.DropDown <> IndexAdditionalType.AutoSustitución AndAlso _Index.DropDown <> IndexAdditionalType.AutoSustituciónJerarquico Then
                                    strselect.Append(" as [")
                                    strselect.Append(_Index.Name)
                                    strselect.Append("]")
                                End If
                            End If
                    ' Exit For
                    '    End If
                    'Next
                Else
                    strselect.Append(",")
                    strselect.Append("I.I")
                    strselect.Append(_Index.ID)

                    If _Index.DropDown = IndexAdditionalType.AutoSustitución OrElse _Index.DropDown = IndexAdditionalType.AutoSustituciónJerarquico Then
                        strPREselect.Append(", slst_s" & _Index.ID & ".Descripcion")
                        auIndex.Add(_Index.ID)
                        strPREselect.Append(" as [")
                        strPREselect.Append(_Index.Name)
                        strPREselect.Append("]")
                    End If

                    If _Index.DropDown <> IndexAdditionalType.AutoSustitución AndAlso _Index.DropDown <> IndexAdditionalType.AutoSustituciónJerarquico Then
                        strselect.Append(" as [")
                        strselect.Append(_Index.Name)
                        strselect.Append("]")
                    End If

                End If
            Next

            '            End If

            If Server.isOracle Then
                strselect.Replace("[", Chr(34))
                strselect.Replace("]", Chr(34))
                strPREselect.Replace("[", Chr(34))
                strPREselect.Replace("]", Chr(34))
            End If

            'If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then
            '    If Server.isOracle Then 'Se agrega la paginacion, ademas el ordenamiento iria acá
            '        strPREselect.Append(" ,NVL2(dRead.DOCID, 1,0) AS Leido") ' 1 = true = leido / 0 = false = No Leido
            '        strselect.Append(" ,row_number() over (order by TASK_ID")
            '        strselect.Append(") rn")
            '    End If
            '    strselect.Append(" FROM WFDOCUMENT WD ")
            'Else
            If Server.isOracle Then 'Se agrega la paginacion, ademas el ordenamiento iria acá
                strPREselect.Append(" ,NVL2(dRead.DOCID, 1,0) AS Leido") ' 1 = true = leido / 0 = false = No Leido
                strselect.Append(" ,row_number() over (order by ")

                'Ordenamiento Interno
                If Not orderBy.Contains("I.") Then
                    Dim OrderInt As String = Nothing
                    Dim ordensincomillas As String = Nothing
                    If orderBy.Contains("DOC") Then
                        ordensincomillas = orderBy.Substring(0, orderBy.Length).Replace(Chr(34), "")
                        OrderInt = ordensincomillas.Substring(0, ordensincomillas.Length).Replace("DOC TYPE NAME", "'" + docType.Name + "'")
                        orderBy = OrderInt
                    ElseIf orderBy.Contains("ASSIGNEDTO") Then
                        ordensincomillas = orderBy.Substring(0, orderBy.Length).Replace(Chr(34), "")
                        OrderInt = ordensincomillas.Substring(0, ordensincomillas.Length).Replace("ASSIGNEDTO", "User_Asigned")
                        orderBy = OrderInt
                    ElseIf orderBy.Contains("STEP") Then
                        ordensincomillas = orderBy.Substring(0, orderBy.Length).Replace(Chr(34), "")
                        OrderInt = ordensincomillas.Substring(0, ordensincomillas.Length).Replace("STEP", "Step_Id")
                        orderBy = OrderInt
                    ElseIf orderBy.Contains("INGRESO") Then
                        ordensincomillas = orderBy.Substring(0, orderBy.Length).Replace(Chr(34), "")
                        OrderInt = ordensincomillas.Substring(0, ordensincomillas.Length).Replace("INGRESO", "checkin")
                        orderBy = OrderInt
                    ElseIf orderBy.Contains("NAME") Then
                        ordensincomillas = orderBy.Substring(0, orderBy.Length).Replace(Chr(34), "")
                        OrderInt = ordensincomillas.Substring(0, ordensincomillas.Length).Replace("NAME", "name")
                        orderBy = OrderInt
                    Else
                        orderBy = "I.doc_id desc"
                        End If
                    Else
                        Dim OrderDocidInt As String = Nothing
                    OrderDocidInt = orderBy.Substring(0, (orderBy.LastIndexOf(" ") + 1))
                    Dim SplitStrSelectInt() As String
                    Dim tmpList As New List(Of String)
                    Dim Splitfilter As String


                    SplitStrSelectInt = strselect.ToString.Split(",")

                    For Each s As String In SplitStrSelectInt
                        If s.Contains("I.I") Then
                            If s.Contains("as") Then
                                Splitfilter = s.Substring(0, (s.IndexOf(" ") + 1))
                                tmpList.Add(Splitfilter.Trim)
                            Else
                                tmpList.Add(s)
                            End If
                        End If
                    Next

                    If Not tmpList.Contains(OrderDocidInt.Trim) Then
                        orderBy = "I.doc_id desc"
                        Flagdocid = True
                    End If
                End If

                strselect.Append(orderBy)
                strselect.Append(") rn")

            End If

            strselect.Append(" FROM DOC_I" & docType.ID & " I ")
            strPOSTselect.Append(MainJoin)
            strPOSTselect.Append("  left outer join doc_type On doc_type.doc_type_id = ")
            strPOSTselect.Append("T.doc_type_id left outer join disk_Volume On disk_Vol_id=vol_id ")

            If auIndex.Count > 0 Then
                For Each indiceID As Int64 In auIndex
                    If Server.isOracle Then
                        strPOSTselect.Append(" left outer join slst_s" & indiceID & " On i.i" & indiceID & " = TO_CHAR(slst_s" & indiceID & ".codigo) ")
                    Else
                        strPOSTselect.Append(" left outer join slst_s" & indiceID & " On i.i" & indiceID & " = slst_s" & indiceID & ".codigo ")
                    End If
                Next
            End If
            'End If

            ' If IsTask Then
            'If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then

            'Else
            strselect.Append(" left outer join WFDOCUMENT wd On ")
            strselect.Append("I.DOC_ID = wd.DOC_ID ")
            'End If

            strPOSTselect.Append(" left join WFWORKFLOW ww On i.work_id = ww.work_id ")
            strPOSTselect.Append(" left outer join WFSTEP ws On i.step_id = ws.step_id ")
            strPOSTselect.Append(" left outer join WFSTEPSTATES wss On i.do_state_id = wss.doc_state_id ")
            strPOSTselect.Append(" left outer join zuser_or_group u On i.User_asigned = u.id ")
            '  End If
            ' strPREselect.Append(" left outer join ZThumb THUMB On i.DOC_ID= THUMB.DOC_ID ")
            strPOSTselect.Append(" LEFT JOIN ZDOCREADS dRead On i.DOC_ID = dRead.DOCID And dRead.userid = " & Search.UserId)
            'strPREselect.Append("LEFT JOIN ZDOCREADS dRead On i.DOC_ID = dRead.DOCID And dRead.userid = " & Search.UserId)

            If Search.SearchType = SearchTypes.AsignedTasks AndAlso Not IsNothing(Search.UserId) Then

                strPOSTselect.Append(" LEFT JOIN ZVW_USR_R_GROUPSANDTHEIRINH ZVW On I.USER_ASIGNED = ZVW.GROUPID And I.USER_ASIGNED = Zvw.Usrid")

                Dim usrsAndGroupsStr As StringBuilder = New StringBuilder()

                If (Search.View.Contains("MyTasks") AndAlso Not Search.View.Contains("ViewAllMy")) Then
                    usrsAndGroupsStr.Append(Search.UserId.ToString() & ",")
                End If

                If (Search.View.Contains("MyTeam") AndAlso Not Search.View.Contains("ViewAllMy")) Then
                    Dim _user As IUser = UserBusiness.GetUserById(Search.UserId)
                    For Each group As IUserGroup In _user.Groups
                        usrsAndGroupsStr.Append(group.ID.ToString & ",")
                    Next
                End If

                If usrsAndGroupsStr.Length > 0 Then
                    usrsAndGroupsStr.Remove(usrsAndGroupsStr.Length - 1, 1)
                    If (strselect.ToString.Contains("WHERE")) Then
                        strselect.Append(" And ")
                    Else
                        strselect.Append(" WHERE ")
                    End If
                    strselect.Append(String.Format("  User_Asigned In ({0})  ", usrsAndGroupsStr.ToString()))
                End If

                If (Search.View.Contains("View=")) Then
                    Dim View As String = Search.View.Replace("View=", "")
                    Dim UP As New UserPreferences
                    Dim ViewScript As String = UP.getValue(View, UPSections.Views, "", Search.UserId)
                    If ViewScript.Length > 0 Then
                        If (strselect.ToString.Contains("WHERE")) Then
                            strselect.Append(" And ")
                        Else
                            strselect.Append(" WHERE ")
                        End If
                        strselect.Append(ViewScript)
                    End If
                End If

            End If

            auIndex = Nothing
        End Sub


        ''' -----------------------------------------------------------------------------
        ''' <summary>
        ''' Devuelve un Arraylist de objetos Results obtenidos al ejecutar la sentencia SQL
        ''' </summary>
        ''' <param name="SQL">Sentencia SQL a ejecutar</param>
        ''' <returns>Arraylist de objetos Results</returns>
        ''' <remarks>
        ''' </remarks>
        ''' <history>
        ''' 	[Hernan]	29/05/2006	Created
        ''' </history>
        ''' -----------------------------------------------------------------------------
        Public Overloads Function SearchRows(ByVal SQL As String) As DataTable
            Dim dr As IDataReader = Nothing
            Dim dt As DataTable = New DataTable
            Dim con As IConnection = Nothing

            Dim UP As New UserPreferences

            Try
                ZTrace.WriteLineIf(ZTrace.IsInfo, "Devuelve los resultados de la base de datos " & Now.ToString)
                Dim CountTop As Int64 = Int64.Parse(UP.getValue("MaxResults", UPSections.UserPreferences, 100, Membership.MembershipHelper.CurrentUser.ID))
                Dim docTypeId As Int64 = 0
                Dim arraySustIndex As ArrayList = Nothing
                Dim first As Boolean = True
                Dim i As Int32 = 0
                Dim Indexs As List(Of IIndex) = Nothing

                con = Server.Con
                dr = con.ExecuteReader(CommandType.Text, SQL)
                While (dr.Read() AndAlso i < CountTop)
                    i = i + 1
                    If docTypeId <> dr.Item("doc_type_Id") Then
                        Indexs = ZCore.FilterIndex(dr.Item("doc_type_Id"))
                    End If

                    CreateRow(arraySustIndex, dr, Indexs)
                End While

            Finally
                If Not IsNothing(dr) Then
                    dr.Close()
                    dr.Dispose()
                    dr = Nothing
                End If
                If Not IsNothing(con) Then
                    con.Close()
                    con.dispose()
                    con = Nothing
                End If
                UP = Nothing
            End Try
            Return dt
        End Function

#End Region

#Region "DocumentalSearch"
        Private Shared Function FileIsIndexed(ByVal IndexedResults As ArrayList, ByVal Result As Result) As Boolean
            Try
                If Not IsNothing(IndexedResults) Then
                    For Each S As String In IndexedResults
                        If S = Result.Doc_File Then
                            Return True
                        End If
                    Next
                Else
                    Return False
                End If
            Catch ex As Exception
                ZClass.raiseerror(ex)
            End Try
        End Function
#End Region

#Region "BinarySearch"
        Public Shared Function SearchFileText(ByRef Results As ArrayList, ByVal Text2Search As String, ByVal AllFiles As Boolean) As ArrayList
            Try
                Dim i As Int32
                Dim NewResults As New ArrayList
                Dim CountRows As Int64

                For i = 0 To Results.Count - 1
                    Dim Result As Result = Results(i)
                    Try
                        If FileContainsText(Result.FullPath, Text2Search, AllFiles) Then
                            NewResults.Add(Result)
                            CountRows += 1
                        End If
                    Catch ex As Exception
                        Zamba.Core.ZClass.raiseerror(ex)
                    End Try
                Next
                NewResults.Capacity = CountRows

                Return NewResults
            Catch ex As Exception
                Zamba.Core.ZClass.raiseerror(ex)
            End Try
            Return Nothing
        End Function
        Public Shared Function FileContainsText(ByVal filename As String, ByVal text As String, ByVal SearchAll As Boolean) As Boolean
            Dim Words() As String = Split(text.Trim, " ")
            Return FileContainsText(filename, Words, SearchAll)
        End Function
        Private Shared Function FileContainsText(ByVal filename As String, ByVal words() As String, ByVal SearchAll As Boolean) As Boolean
            Dim Errors As Boolean
            If isText(filename) = False Then Return False

            ' -------------------------------------------------
            ' TO DO: Crear un diccionario para de alguna forma reconocer una palabra con acento. Por ejemplo: se tiene la palabra programación en el
            ' archivo txt y en alltext programación va aparecer como programaci[]on (en realidad con un cuadrado) por lo tanto, nunca se va a encontrar
            ' la palabra con acento cuando se realize el indexOf
            ' -------------------------------------------------

            Dim alltext As String = GetFileText(filename, Errors)

            Dim wordFind As Int32 = 0

            For Each w As String In words
                If alltext.IndexOf(w.ToLower) <> -1 Then
                    wordFind += 1

                    If SearchAll Then
                        If wordFind = words.Length Then
                            Return True
                        End If
                    Else
                        Return True
                    End If
                End If
            Next
            Return False
        End Function
        Public Shared Function isText(ByVal filename As String) As Boolean
            If IsNothing(filename) Then
                Return False
            End If

            Dim Fi As New FileInfo(filename.Trim)

            If (String.Compare(Fi.Extension, ".doc", True) = 0) Then Return True
            If (String.Compare(Fi.Extension, ".wri", True) = 0) Then Return True
            If (String.Compare(Fi.Extension, ".pdf", True) = 0) Then Return True
            If (String.Compare(Fi.Extension, ".htm", True) = 0) Then Return True
            If (String.Compare(Fi.Extension, ".html", True) = 0) Then Return True
            If (String.Compare(Fi.Extension, ".xls", True) = 0) Then Return True
            If (String.Compare(Fi.Extension, ".txt", True) = 0) Then Return True
            Return False
        End Function
        Private Shared Function GetFileText(ByVal FileName As String, ByVal Errors As Boolean) As String
            Dim Text As String = String.Empty

            Dim Fi As New FileInfo(FileName)

            Dim Fs As FileStream = Nothing
            Dim Sr As StreamReader = Nothing

            Errors = False

            Try
                Fs = Fi.OpenRead()
                Sr = New StreamReader(Fs)
            Catch ex As System.IO.IOException
                If IsNothing(Fs) = False Then
                    Fs.Close()
                End If

                If IsNothing(Sr) = False Then
                    Sr.Close()
                End If

                Errors = True
            End Try

            If Errors = False Then
                Text = Sr.ReadToEnd().ToLower()
                Sr.Close()
                Fs.Close()
            End If
            Return Text
        End Function
        ''' <summary>
        ''' Busca el texto especificado en los archivos fìsicos
        ''' </summary>
        ''' <param name="Results"></param>
        ''' <param name="Text2Search"></param>
        ''' <param name="AllFiles"></param>
        ''' <history>Marcelo    modified    19/08/2009</history>
        ''' <returns></returns>
        ''' <remarks></remarks>
        Public Shared Function SearchFileText(ByVal Results As DataTable, ByVal Text2Search As String, ByVal AllFiles As Boolean) As DataTable
            Try
                Dim NewResults As DataTable = Results.Clone()

                For Each Result As DataRow In Results.Rows
                    Try
                        If FileContainsText(getFullPath(Result), Text2Search, AllFiles) Then
                            NewResults.Rows.Add(Result.ItemArray)
                        End If
                    Catch ex As Exception
                        Zamba.Core.ZClass.raiseerror(ex)
                    End Try
                Next

                Return NewResults
            Catch ex As Exception
                Zamba.Core.ZClass.raiseerror(ex)
            End Try
            Return Nothing
        End Function

        ''' <summary>
        ''' Obtiene la ruta 
        ''' </summary>
        ''' <param name="result"></param>
        ''' <history>Marcelo    created 19/08/2009</history>
        ''' <returns></returns>
        ''' <remarks></remarks>
        Public Shared Function getFullPath(ByVal result As DataRow) As String
            If result.Item("Disk_group_id") = -1 Then
                Return result.Item("doc_file")
            ElseIf result.Item("Disk_group_id") = 0 Then
                Return String.Empty
            Else
                Return result.Item("disk_vol_path") & "\" & result.Item("doc_type_id") & "\" & result.Item("offset") & "\" & result.Item("doc_file")
            End If
        End Function
#End Region

#Region "NotesSearch"
        ''' -----------------------------------------------------------------------------
        ''' <summary>
        ''' Funcion para realizar busquedas en Notas y comentarios del Foro
        ''' </summary>
        ''' <param name="Results">Arraylist de objetos Results donde se va a realizar la busqueda </param>
        ''' <param name="Text2Search">Texto que se desea buscar</param>
        ''' <returns>Arraylist de resultados</returns>
        ''' <remarks>
        ''' </remarks>
        ''' <history>
        ''' 	[Hernan]	29/05/2006	Created
        ''' </history>
        ''' -----------------------------------------------------------------------------
        Public Function SearchInNotesAndForo(ByRef Results As ArrayList, ByVal SearchString As String) As ArrayList
            Dim NewResults As New Hashtable
            Dim ResultsList As New ArrayList
            'Dim CountRows As Int64

            Try
                Dim SelectQuery As String = "Select Doc_Id FROM Doc_notes where (lower(Note_text) Like '%" & SearchString.Trim.ToLower & "%')"
                Dim DsTemp As DataSet = Server.Con.ExecuteDataset(CommandType.Text, SelectQuery)
                Dim Doc_IdOrdinal As Int32 = DsTemp.Tables(0).Columns("DOC_ID").Ordinal

                For Each Row As DataRow In DsTemp.Tables(0).Rows
                    For Each CurrentResult As Result In Results
                        If Row.Item(Doc_IdOrdinal) = CurrentResult.ID Then
                            NewResults.Add(CurrentResult.ID, CurrentResult)
                        End If
                    Next
                Next

            Catch ex As Exception
                Zamba.Core.ZClass.raiseerror(ex)
            End Try

            Try
                Dim SelectQuery As String = "SELECT DocId, Mensaje, LinkName FROM ZForum WHERE (lower(Mensaje) Like '%" & LCase(SearchString.Trim) & "%') OR (lower(LinkName) Like '%" & LCase(SearchString.Trim) & "%')"
                Dim DsTemp As DataSet = Server.Con.ExecuteDataset(CommandType.Text, SelectQuery)
                Dim DocIdOrdinal As Int32 = DsTemp.Tables(0).Columns("DOCID").Ordinal

                For Each Row As DataRow In DsTemp.Tables(0).Rows
                    For Each CurrentResult As Result In Results
                        If Row.Item(DocIdOrdinal) = CurrentResult.ID Then
                            NewResults.Add(CurrentResult.ID, CurrentResult)
                        End If
                    Next
                Next

            Catch ex As Exception
                Zamba.Core.ZClass.raiseerror(ex)
            End Try
            ResultsList.AddRange(NewResults.Values)
            ResultsList.Capacity = NewResults.Count
            Return ResultsList
        End Function

        ''' -----------------------------------------------------------------------------
        ''' <summary>
        ''' Funcion para realizar busquedas en Notas y comentarios del Foro
        ''' </summary>
        ''' <param name="Results">Arraylist de objetos Results donde se va a realizar la busqueda </param>
        ''' <param name="Text2Search">Texto que se desea buscar</param>
        ''' <returns>Arraylist de resultados</returns>
        ''' <remarks>
        ''' </remarks>
        ''' <history>
        ''' 	[Hernan]	29/05/2006	Created
        ''' 	[Marcelo]	19/08/2009	Modified
        ''' </history>
        ''' -----------------------------------------------------------------------------
        Public Shared Function SearchInNotesAndForo(ByVal Results As DataTable, ByVal SearchString As String) As DataTable
            Dim NewResults As DataTable = Results.Clone()
            Try
                Dim SelectQuery As String = "SELECT Doc_Id FROM Doc_notes where (lower(Note_text) LIKE '%" & SearchString.Trim.ToLower & "%')"
                Dim DsTemp As DataSet = Server.Con.ExecuteDataset(CommandType.Text, SelectQuery)
                Dim Doc_IdOrdinal As Int32 = DsTemp.Tables(0).Columns("DOC_ID").Ordinal

                For Each Row As DataRow In DsTemp.Tables(0).Rows
                    For Each CurrentResult As DataRow In Results.Rows
                        If Row.Item(Doc_IdOrdinal) = CurrentResult("doc_ID") Then
                            NewResults.Rows.Add(CurrentResult.ItemArray())
                        End If
                    Next
                Next
            Catch ex As Exception
                Zamba.Core.ZClass.raiseerror(ex)
            End Try

            Try
                Dim SelectQuery As String = "SELECT DocId, Mensaje, LinkName FROM ZForum WHERE (lower(Mensaje) Like '%" & LCase(SearchString.Trim) & "%') OR (lower(LinkName) Like '%" & LCase(SearchString.Trim) & "%')"
                Dim DsTemp As DataSet = Server.Con.ExecuteDataset(CommandType.Text, SelectQuery)
                Dim DocIdOrdinal As Int32 = DsTemp.Tables(0).Columns("DOCID").Ordinal

                For Each Row As DataRow In DsTemp.Tables(0).Rows
                    For Each CurrentResult As DataRow In Results.Rows
                        If Row.Item(DocIdOrdinal) = CurrentResult("doc_id") Then
                            NewResults.Rows.Add(CurrentResult.ItemArray())
                        End If
                    Next
                Next
            Catch ex As Exception
                Zamba.Core.ZClass.raiseerror(ex)
            End Try

            Return NewResults
        End Function
#End Region

#Region "Versions"
        ''' <summary>
        ''' Muestra las versiones padre del documento
        ''' </summary>
        ''' <param name="Result"></param>
        ''' <returns></returns>
        ''' <history>   Marcelo Modified 20/08/2009</history>
        ''' <remarks></remarks>
        Public Function SearchParentVersions(ByRef Result As Result, ByVal DtoOnly As Boolean) As DataTable
            'Si RootId = 0 <==> Este result no es una version nueva de otro result , la consulta traeria a todos los results que tienen rootId = 0 que son todos los results NO versionados.
            If Result.RootDocumentId = 0 Then Return Nothing

            'TODO Falta que lo saque del dscore
            'TODO Falta que se pueda configurar
            Try
                If IsNothing(Result.DocType) Then
                    Result.DocType = New DocType(Result.DocType.ID, Result.DocType.Name, 0)
                End If

                Return SearchVersions(Result.DocType, Result.RootDocumentId, Result.ID, DtoOnly, Nothing)
            Catch ex As Exception
                Zamba.Core.ZClass.raiseerror(ex)
            End Try
            Return Nothing
        End Function

        ''' <summary>
        ''' Busca las versiones
        ''' </summary>
        ''' <param name="docType"></param>
        ''' <param name="rootDocumentId"></param>
        ''' <param name="docId"></param>
        ''' <returns></returns>
        ''' <history>   Marcelo Modified 20/08/2009</history>
        ''' <remarks></remarks>
        Public Function SearchVersions(ByVal docType As DocType, ByVal rootDocumentId As Int64, ByVal docId As Int64, ByVal DtoOnly As Boolean, ByVal search As ISearch) As DataTable

            Dim UP As New UserPreferences
            Try

                Dim strselect As New StringBuilder
                Dim strPREselect As New StringBuilder
                Dim strPOSTselect As New StringBuilder
                Dim IB As New IndexsBusiness
                Dim Indexs As New List(Of IIndex)
                If search.SearchType <> SearchTypes.AsignedTasks Then
                    Indexs = IB.FilterIndexsByUserRights(docType.ID, Membership.MembershipHelper.CurrentUser.ID, docType.Indexs, RightsType.TaskGridIndexView)
                End If
                createSelectSearch(docType, Indexs, DtoOnly, String.Empty, search, strselect, strPREselect, strPOSTselect)

                If rootDocumentId > 0 Then
                    strselect.Append(" WHERE ")
                    strselect.Append("RootId = ")
                    strselect.Append(rootDocumentId.ToString())
                    strselect.Append(" OR ")
                    strselect.Append("t.doc_id = ")
                    strselect.Append(rootDocumentId.ToString())
                Else
                    strselect.Append(" WHERE ")
                    strselect.Append("t.doc_id = ")
                    strselect.Append(docId.ToString())
                End If

                Dim CountTop As Int64 = Int64.Parse(UP.getValue("MaxResults", UPSections.UserPreferences, 100, search.UserId))
                Dim con As IConnection = Nothing
                Dim dr As IDataReader = Nothing
                Dim dt As New DataTable

                Try
                    dr = Server.Con.ExecuteReader(CommandType.Text, strselect.ToString)

                    Dim arraySustIndex As ArrayList = Nothing
                    Dim i As Int32 = 0
                    Dim first As Boolean = True

                    While (dr.Read() AndAlso i < CountTop)
                        i = i + 1

                        CreateRow(arraySustIndex, dr, docType.Indexs)
                    End While

                Finally
                    If Not IsNothing(dr) Then
                        dr.Close()
                        dr.Dispose()
                        dr = Nothing
                    End If
                    If Not IsNothing(con) Then
                        con.Close()
                        con.dispose()
                        con = Nothing
                    End If
                End Try
                Return dt
            Catch ex As Exception
                Zamba.Core.ZClass.raiseerror(ex)
            Finally
                UP = Nothing
            End Try
            Return Nothing
        End Function
#End Region

    End Class
End Namespace
