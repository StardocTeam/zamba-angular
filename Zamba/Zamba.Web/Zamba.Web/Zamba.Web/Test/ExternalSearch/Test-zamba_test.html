<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />

    <title>External Search</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
       
        .imgclass{
            right: 4%;
            position: absolute;
            top: 7%;
        }
        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
        }

            .active, .accordion:hover {
                background-color: #ccc;
            }

        .panel {
            padding: 0 18px;
            display: none;
            background-color: white;
            overflow: hidden;
        }

        .Textarea1 {
            resize: none;
            height: 70px !important;
        }
         .Textarea2 {
            resize: none;
            height: 150px !important;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="page-header">
            <h1><small>External Search</small></h1>
            <img src="../../forms/Provincia/images/zamba_BPM_color.jpg" height="45" class="imgclass" width="135" longdesc="Probando imagen abajo y en el centro" />

        </div>

        <div class="col-md-12">

            <!-- LISTA ERRORES -->
			<div class="col-md-12" style="margin-bottom: 15px;">
                <div class="col-md-5">
                    <input id="urlSite" class="form-control" value="imageapd/ZambaDesa.RestApi" placeholder="Ingrese la Url del sitio" />
                </div>
                <div class="col-md-1"></div>
                <div class="col-md-6">
                    <span class="label label-danger">Importante!</span>
                    </br>
                    <span style="color: #777;"> Se debe colocar el url del servidor al que se quiere apuntar el RestApi Ejemplo:</span>
                    </br>
                    <span style="color: #777;"><strong>DESARROLLO:</strong> Imageapd/ZambaWeb.RestApi</span>
                    </br>
                    <span style="color: #777;"><strong>TEST:</strong> Imageapt/ZambaWeb.RestApi</span>
                </div>
            </div>

            <button class="accordion">Login</button>
            <div class="panel">
                <div class="container" style="margin-top:10px">
                    <div class="form-horizontal">
                        <div class=" col-md-4">
                            <div class="form-group">
                                <span>Usuario:</span>
                                <input id="Usuario" placeholder="Ingrese su Usuario" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>Clave:</span>
                                <input id="clave" placeholder="Ingrese su Clave" class="form-control" />
                            </div>
                            <div class="form-group">
                                <button id="btn-login" class="btn btn-success btn-md">Login</button>
                            </div>


                        </div>

                        <div class="col-md-1">

                        </div>
                        <div class="col-md-7">
                            <div class="form-group">
                                <textarea id="loginRequest" class="form-control Textarea1" aria-label="With textarea"></textarea>
                            </div>
                            <div class="form-group">
                                <textarea id="loginResult" class="form-control Textarea2" aria-label="With textarea"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <button class="accordion">Busqueda</button>
            <div class="panel">
                <div class="container" style="margin-top:10px">
                    <div class="form-horizontal">
                        <div class=" col-md-4">
                            <div class="form-group">
                                <span>token: </span>
                                <input id="TokenSearchID" placeholder="Ingrese su token" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>UserID: </span>
                                <input id="UserID" placeholder="Ingrese su UserID" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>DoctypesIds: </span>
                                <input id="DoctypesIds" placeholder="Ingrese el DoctypesIds" class="form-control" />
                            </div>
                            <div class="form-group ">
                                <span>indexID: </span>
                                <input id="indexID" placeholder="Ingrese su indexID" class="form-control" />

                            </div>
                            <div class="form-group">
                                <span>indexData: </span>
                                <input id="indexData" placeholder="Ingrese su indexData" class="form-control" />
                            </div>

                            <div class="form-group">
                                <button id="btn-search" class="btn btn-primary btn-md">Busqueda</button>
                            </div>
                        </div>

                        <div class="col-md-1">

                        </div>
                        <div class="col-md-7">
                            <div class="form-group">
                                <textarea id="searchRequest" class="form-control Textarea1" aria-label="With textarea"></textarea>
                            </div>
                            <div class="form-group">
                                <textarea id="searchResult" class="form-control Textarea2" aria-label="With textarea"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="accordion">Descarga de documento</button>
            <div class="panel">
                <div class="container" style="margin-top:10px">
                    <div class="form-horizontal">
                        <div class=" col-md-4">
                            <div class="form-group">
                                <span>token: </span>
                                <input id="TokenSearchIDs" placeholder="Ingrese su token" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>ID: </span>
                                <input id="SearchID" placeholder="Ingrese su id" class="form-control" />
                            </div>
                            <div class="form-group">
                                <span>UserID: </span>
                                <input id="UserIDs" placeholder="Ingrese su UserID" class="form-control" />
                            </div>
                            <div class="form-group">
                                <button id="btn-downloadDoc" class="btn btn-info btn-md">Descarga</button>
                            </div>
                        </div>

                        <div class="col-md-1">

                        </div>
                        <div class="col-md-7">
                            <div class="form-group">
                                <textarea id="docFileRequest" class="form-control Textarea1" aria-label="With textarea"></textarea>
                            </div>
                            <div class="form-group">
                                <textarea id="docFileResult" class="form-control Textarea2" aria-label="With textarea"></textarea>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <iframe id="iframeID" height="100%" width="100%"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <button class="accordion">Cierre de session</button>
            <div class="panel">
                <div class="container" style="margin-top:10px">
                    <div class="form-horizontal">
                        <div class=" col-md-4">
                            <div class="form-group">
                                <span>UserID: </span>
                                <input id="UserIDclose" placeholder="Ingrese su UserID" class="form-control" />
                            </div>
                            <div class="form-group">
                                <button id="btn-endSession" class="btn btn-secondary btn-md">Cierre</button>
                            </div>
                        </div>

                        <div class="col-md-1">

                        </div>
                        <div class="col-md-7">
                            <div class="form-group">
                                <textarea id="EndSessionRequest" class="form-control Textarea1" aria-label="With textarea"></textarea>
                            </div>
                            <div class="form-group">
                                <textarea id="EndSessionResult" class="form-control Textarea2" aria-label="With textarea"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        

    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
</body>

</html>

<script>

    var acc = document.getElementsByClassName("accordion");
    var i;

        for (i = 0; i < acc.length; i++) {
          acc[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.display === "block") {
              panel.style.display = "none";
            } else {
              panel.style.display = "block";
            }
          });
        }
   

    var generatedToken;
    var _userName;
    var _userClave;
   
   var DominioUrl = $("#urlSite").val();
    

    $("#btn-login").click(function () {

        _userName = $("#Usuario").val();
        _userClave = $("#clave").val();
		var DominioUrl = $("#urlSite").val();
        //var apiUrl = "http://localhost/ZambaWeb.RestApi/api/ExternalSearch/Login";
        var apiUrl = "http://"+DominioUrl+"/api/ExternalSearch/Login";
        var data = {
            UserName: _userName,
            Password: _userClave,
            ComputerNameOrIp: "00000000"
        }
        
        $("#loginRequest").text(JSON.stringify(data));
       
        $.ajax({
            type: "post",
            url: apiUrl,
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            crossDomain: true,
            success: function (data) {
                generatedToken = data.token;
                _userId = data.userID;
                $("#loginResult").text(JSON.stringify(data));
                 LLenadoInput(data);
            },
            error: function (data) {
                 $("#loginResult").text(JSON.stringify(data));
            }
        });
    });


    $("#btn-search").click(function () {

       
        var _DoctypesIds = $("#DoctypesIds").val();;
        var _indexData = $("#indexData").val(); ;
        var _indexID = $("#indexID").val();;
        var _token = $("#TokenSearchID").val();
        var _userId = $("#UserID").val();
		var DominioUrl = $("#urlSite").val();
        //var apiUrl = "http://localhost/ZambaWeb.RestApi/api/ExternalSearch/SearchResults";
        var apiUrl = "http://"+DominioUrl+"/api/ExternalSearch/SearchResults";
        var data = {
            ExternUserID: _userId,
            DoctypesIds: [_DoctypesIds],
            Indexs: [{ "id": _indexID, "data": _indexData }]
        }

        $("#searchRequest").text(JSON.stringify(data));
      
        $.ajax({
            type: "post",
            url: apiUrl,
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            crossDomain: true,
            headers: { "Authorization": _token },
            success: function (data) {

                $("#searchResult").text(JSON.stringify(data));
                if (data != "" && data != "null" && data != "undefined") {
                    $("#SearchID").val(data[0].ID);
                }
                
            },
            error: function (data) {
                $("#searchResult").text(JSON.stringify(data));
            }
        });
    });

    $("#btn-downloadDoc").click(function () {

        var _token = $("#TokenSearchIDs").val();
        var _SearchID = $("#SearchID").val();
        var  _userId = $("#UserIDs").val();
		var DominioUrl = $("#urlSite").val();
        //var apiUrl = "http://localhost/ZambaWeb.RestApi/api/ExternalSearch/GetDocFile";
        var apiUrl = "http://"+DominioUrl+"/api/ExternalSearch/GetDocFile";
        var data = {
            //UserId: _userId,
            Params: {
                "id": _SearchID,
                "externuserid": _userId,
            }
        }

        $("#docFileRequest").text(JSON.stringify(data));


        $.ajax({
            type: "post",
            url: apiUrl,
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            crossDomain: true,
            headers: { "Authorization": _token },
            success: function (data) {
                $("#docFileResult").text(JSON.stringify(data));
                var a = "data:application/pdf;base64," + data;
                $("#iframeID").attr("src", a);
            },
            error: function (data) {
                
                $("#docFileResult").text(JSON.stringify(data));
                 $("#iframeID").removeAttr("src");
            }
        });
    });

    $("#btn-endSession").click(function () {

         var _userId = $("#UserIDclose").val();
        //$("#EndSessionRequest").text("");
        //$("#EndSessionResult").text("");
		var DominioUrl = $("#urlSite").val();
        //var apiUrl = "http://localhost/ZambaWeb.RestApi/api/ExternalSearch/EndSession";
        var apiUrl = "http://"+DominioUrl+"/api/ExternalSearch/EndSession";
        var data = {
            Params: { "externuserid": _userId }
        }

        $("#EndSessionRequest").text(JSON.stringify(data));
        
        $.ajax({
            type: "post",
            url: apiUrl,
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            crossDomain: true,
            success: function (data) {
               
                $("#EndSessionResult").text(JSON.stringify(data));
                //BorradoInput(data);
            },
            error: function (data) {
                $("#EndSessionResult").text(JSON.stringify(data));
            }
        });
    });


    function LLenadoInput(data) {
        var resultToken = data.token;
        if (resultToken != "" && resultToken != "undefined" && resultToken != "null") {
            $("#TokenSearchID").val(resultToken);
            $("#TokenSearchIDs").val(resultToken);
        }

        var resultID = data.userID;
        if (resultID != "" && resultID != "undefined" && resultID != "null") {
            $("#UserIDs").val(resultID);
            $("#UserID").val(resultID);
            $("#UserIDclose").val(resultID);
            
        }

        
    }

    function BorradoInput(data) {

        if (data == "Session closed") {
            $("#TokenSearchID").val("");
            $("#TokenSearchIDs").val("");
            $("#UserIDs").val("");
            $("#UserID").val("");
            $("#UserIDclose").val("");
            $("#clave").val("");
            $("#Usuario").val("");
        }

    }


</script>