<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container-fluid">
        <div class=" row col-xs-10 col-xs-offset-2">
            <h4>URL: </h4> <input id="url" type="text" style="width:500px" value="http://localhost:44301/ZambaWeb.RestApi/api/InsertFiles/UploadFileWithIndexReturn" />
        </div>

        <div class=" row col-xs-10 col-xs-offset-2">
            <h4>           urlPRD   http://imageapp/zamba.restapi/api/InsertFiles/UploadFileWithIndexReturn  </h4>
        </div>

        <div class=" row col-xs-10 col-xs-offset-2">
            <h4>      urlTEST   http://imageapt/zamba.restapi/api/InsertFiles/UploadFileWithIndexReturn  </h4>
        </div>

        <div class=" row col-xs-10 col-xs-offset-2">
            <h4>        urlDESA   http://imageapd/zamba.restapi/api/InsertFiles/UploadFileWithIndexReturn  </h4>
        </div>


        <div class=" row col-xs-10 col-xs-offset-2">
            <input name="Upload" id="image" onchange="UploadIMG(this)" type="file" />
        </div>

        <div class=" row col-xs-10 col-xs-offset-2">
            <label>UserId<input class="form-control col-xs-4" id="userid" value="3" /></label>

            <label>EntityId<input class="form-control col-xs-4 " id="id" value="8" /></label>
        </div>
        <div id="" class="  col-xs-offset-2">

            <div class=" row col-xs-10">
                <div class="col-xs-4 indicesid"><label>ID del indice</label><input class="form-control" value="32" /></div>
                <div class=" col-xs-4 indicesVal"> <label>  Valor del indice</label><input class="form-control col-xs-4" value="4" /></div>
            </div>

            <div class=" row col-xs-10">
                <div class=" col-xs-4 indicesid"><label>ID del indice</label><input class="form-control" value="1147" /></div>
                <div class=" col-xs-4 indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" value="11111" /></div>
            </div>
            <div class=" row col-xs-10">
                <div class=" col-xs-4 indicesid"><label>ID del indice</label><input class="form-control" value="" /></div>
                <div class=" col-xs-4 indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" /></div>
            </div>
            <div class=" row col-xs-10">
                <div class=" col-xs-4 indicesid"><label>ID del indice</label><input class="form-control" value="" /></div>
                <div class=" col-xs-4 indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" /></div>
            </div>

            <div class=" row col-xs-10">
                <div class=" col-xs-4"><label>originalFileName</label><input id="originalFileName" class="form-control" value="" /></div>
            </div>

            <div class=" row col-xs-10">
                <div class=" col-xs-4"><label>ID del indice de retorno</label><input id="returnId" class="form-control" value="1147" /></div>
            </div>


            <div class="row col-xs-10 col-xs-offset-2" style="margin-top:20px">
                <span id="sendinfo" class="btn btn-success col-xs-2" onclick="sendinfo()">Insertar</span>

            </div>
            <div class="row col-xs-6 ">

                <label>ResultValue</label> <input class="form-control " id="resultValue" value="" type="text" />
            </div>


            <div class=" row col-xs-10 col-xs-offset-2">
                <h3>Associated Result 1</h3>
                <label>Associated EntityId<input class="form-control col-xs-4 " id="Associated_1_id" value="8" /></label>
            </div>

            <div id="" class="  col-xs-offset-2">

                <div class=" row col-xs-10">
                    <div class="col-xs-4 Assoc_1_indicesid"><label>ID del indice</label><input class="form-control" value="32" /></div>
                    <div class=" col-xs-4 Assoc_1_indicesVal"> <label>  Valor del indice</label><input class="form-control col-xs-4" value="4" /></div>
                </div>

                <div class=" row col-xs-10">
                    <div class=" col-xs-4 Assoc_1_indicesid"><label>ID del indice</label><input class="form-control" value="1147" /></div>
                    <div class=" col-xs-4 Assoc_1_indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" value="11112" /></div>
                </div>
                <div class=" row col-xs-10">
                    <div class=" col-xs-4 Assoc_1_indicesid"><label>ID del indice</label><input class="form-control" value="" /></div>
                    <div class=" col-xs-4 Assoc_1_indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" /></div>
                </div>
                <div class=" row col-xs-10">
                    <div class=" col-xs-4 Assoc_1_indicesid"><label>ID del indice</label><input class="form-control" value="" /></div>
                    <div class=" col-xs-4 Assoc_1_indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" /></div>
                </div>

            </div>

            <div class=" row col-xs-10 col-xs-offset-2">
                <h3>Associated Result 2</h3>
                <label>Associated EntityId<input class="form-control col-xs-4 " id="Associated_2_id" value="8" /></label>
            </div>

            <div id="" class="  col-xs-offset-2">

                <div class=" row col-xs-10">
                    <div class="col-xs-4 Assoc-2-indicesid"><label>ID del indice</label><input class="form-control" value="32" /></div>
                    <div class=" col-xs-4 Assoc-2-indicesVal"> <label>  Valor del indice</label><input class="form-control col-xs-4" value="4" /></div>
                </div>

                <div class=" row col-xs-10">
                    <div class=" col-xs-4 Assoc-2-indicesid"><label>ID del indice</label><input class="form-control" value="1147" /></div>
                    <div class=" col-xs-4 Assoc-2-indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" value="11113" /></div>
                </div>
                <div class=" row col-xs-10">
                    <div class=" col-xs-4 Assoc-2-indicesid"><label>ID del indice</label><input class="form-control" value="" /></div>
                    <div class=" col-xs-4 Assoc-2-indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" /></div>
                </div>
                <div class=" row col-xs-10">
                    <div class=" col-xs-4 Assoc-2-indicesid"><label>ID del indice</label><input class="form-control" value="" /></div>
                    <div class=" col-xs-4 Assoc-2-indicesVal"> <label> Valor del indice</label><input class="form-control col-xs-4" /></div>
                </div>

            </div>


        </div>
    </div>
</body>
</html>

<style>
</style>

<script>
    var fileSelected = "";
    var fileExtencion = "";
    function UploadIMG(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                var img64 = e.target.result;
                if (e.total > 400000) {
                    var img = new Image();
                    img.src = img64;
                    var width = img.width;
                    var height = img.height;
                    widthext = 500;
                    if (width > widthext) {
                        var oc = document.createElement('canvas'), octx = oc.getContext('2d');
                        oc.width = widthext;
                        oc.height = img.height;
                        octx.drawImage(img, 0, 0);
                        while (oc.width * 0.5 > widthext) {
                            oc.width *= 0.5;
                            oc.height *= 0.5;
                            octx.drawImage(oc, 0, 0, oc.width, oc.height);
                        }
                        oc.width = widthext;
                        oc.height = oc.width * img.height / img.width;
                        octx.drawImage(img, 0, 0, oc.width, oc.height);
                        img64 = oc.toDataURL();
                    }
                }
                fileSelected = img64;
                fileExtencion = $("#image").val().split('.').pop();
            }
            reader.readAsDataURL(input.files[0]);
        }

    }

    $(document).ready(function () {
        $("#url").val("http://localhost:44300/ZambaWeb.RestApi/api/InsertFiles/UploadFileWithIndexReturn");
    });

    function sendinfo() {

        var indexid = $(".indicesid :input");
        var indexval = $(".indicesVal :input");
        var listindex = [];

        var returnId = $("#returnId").val();

        for (var i = 0; i < indexid.length; i++) {
            for (var i = 0; i < indexval.length; i++) {
                if (indexid[i].value && indexval[i].value != "")
                    listindex.push({
                        id: indexid[i].value,
                        value: indexval[i].value
                    });
            }
        }

        var originalFileName = $("#originalFileName").val();
        var doctypeid = $("#id").val();
        var CurrentUserId = $("#userid").val();
        var File = { data: fileSelected, extension: fileExtencion }
        var insert = { file: File, DocTypeId: doctypeid, userid: CurrentUserId, indexs: listindex, returnId: returnId, OriginalFileName: originalFileName, associated: [] };


        var Assoc_1_doctypeid = $("#Associated_1_id").val();

        if (Assoc_1_doctypeid) {
            var Assoc_1_indexid = $(".Assoc_1_indicesid :input");
            var Assoc_1_indexval = $(".Assoc_1_indicesVal :input");
            var Assoc_1_listindex = [];

            for (var i = 0; i < Assoc_1_indexid.length; i++) {
                for (var i = 0; i < Assoc_1_indexval.length; i++) {
                    if (Assoc_1_indexid[i].value && Assoc_1_indexval[i].value != "")
                        Assoc_1_listindex.push({
                            id: Assoc_1_indexid[i].value,
                            value: Assoc_1_indexval[i].value
                        });
                }
            }

            insert.associated.push({ DocTypeId: Assoc_1_doctypeid, indexs: Assoc_1_listindex });
        }

        var Assoc_2_doctypeid = $("#Associated_2_id").val();

        if (Assoc_2_doctypeid) {
            var Assoc_2_indexid = $(".Assoc_2_indicesid :input");
            var Assoc_2_indexval = $(".Assoc_2_indicesVal :input");
            var Assoc_2_listindex = [];

            for (var i = 0; i < Assoc_2_indexid.length; i++) {
                for (var i = 0; i < Assoc_2_indexval.length; i++) {
                    if (Assoc_2_indexid[i].value && Assoc_2_indexval[i].value != "")
                        Assoc_2_listindex.push({
                            id: Assoc_2_indexid[i].value,
                            value: Assoc_2_indexval[i].value
                        });
                }
            }

            insert.associated.push({ DocTypeId: Assoc_2_doctypeid, indexs: Assoc_2_listindex });
        }


        var url = $("#url").val();

        var settings = {
            "async": true,
            "crossDomain": true,
            "url": url,
            "method": "POST",
            "headers": {
                "content-type": "application/json",
                "cache-control": "no-cache"

            },
            "processData": false,
            "data": JSON.stringify(insert)
        }


        $.ajax(settings).done(function (response) {
            console.log(response);
            var result = JSON.parse(response);
            if (result.msg == "OK") {
                $("#resultValue").val(result.ReturnValue);
                toastr.success("archivo se inserto con exito");
            }
            else
                toastr.error('Ocurrio un error en el proceso de su solicitud');
        }).fail(function (jqXHR, textStatus, errorThrown) {
            console.log(jqXHR, textStatus, errorThrown);
            $("#resultValue").val(errorThrown);
        });

    }



</script>



